/**-----------------------------------------------------------------------------
 $Author$
 $Date$
 $HeadURL$
 $Revision$

 -
 License:
 -
 ChangeLog:
 -
 Notes:

 */
goog.provide('CTATShellTools');

goog.require('CTATBase');
goog.require('CTATGlobalFunctions');
goog.require('CTATGlobals');
/**
 * TODO: move components from CTATGlobals to here and use an object instead of
 * an array to improve performance.
 */
CTATShellTools =
{
		ctat_base: new CTATBase("CTATShellTools","shelltools"),

		//components: {},

		/***************** Component Descriptions *****************/
		component_descriptions: {},

		registerComponentDescription: function(aDesc)
		{
			CTATShellTools.ctat_base.ctatdebug ("registerComponentDescription ("+aDesc.name+","+aDesc.type+")");

			CTATShellTools.component_descriptions[aDesc.name] = aDesc;
		},

		listComponents: function()
		{
			CTATShellTools.ctat_base.ctatdebug ("listComponents ()");

			var components = CTATShellTools.component_descriptions;

			//CTATShellTools.ctat_base.ctatdebug ("Nr Components: " + components.length);

			for (var key in components)
			{
				var ref = components[key];
				CTATShellTools.ctat_base.ctatdebug("Obtaining component for " + ref.name + " with type: " + ref.type);
				var component=ref.getComponentPointer ();

				if (component!==null)
				{
					CTATShellTools.ctat_base.ctatdebug ("Component: " +
							component.getName () + " of instance: " +
							component.getClassName ());
				}
				else
				{
					CTATShellTools.ctat_base.ctatdebug ("Error: component pointer is null");
				}
			}
		},


		/***************** Feedback Components *******************/
		// This should probably be moved to a event based model or something
		// like $(.CTATFeedback).ctat_hint_(prev|next|etc.)().
		feedback_components: [],
		registerFeedbackComponent: function(aComponent,
				next_callback,
				previous_callback,
				showHints_callback,
				showFeedback_callback) {
			CTATShellTools.feedback_components.push({
				component:aComponent,
				next: next_callback,
				prev: previous_callback,
				showHints: showHints_callback,
				showFeedback: showFeedback_callback});
		},
		showNextHint: function() {
			CTATShellTools.feedback_components.forEach(function (fbc) {
				if (fbc.next)
					fbc.next.bind(fbc.component)();
			});
		},
		showPrevHint: function() {
			CTATShellTools.feedback_components.forEach(function (fbc) {
				if (fbc.prev)
					fbc.prev.bind(fbc.component)();
			});
		},
		showFeedback: function(/** String */feedback)
		{
			//console.log ("showFeedback ("+feedback+")");

			if (CTATShellTools.feedback_components.length==0)
			{
				CTATScrim.scrim.OKScrimUp (feedback,null);
				return;
			}

			CTATShellTools.feedback_components.forEach(function (fbc)
			{
				if (fbc.showFeedback)
				{
					fbc.showFeedback.bind(fbc.component)(feedback);
				}
			});
		},
		showHints: function(/** Array */ hints) {
			CTATShellTools.feedback_components.forEach(function (fbc) {
				if (fbc.showHints)
					fbc.showHints.bind(fbc.component)(hints);
			});
		},

		/**
		 * Helper function to get the current date in milliseconds.
		 * @return number of milliseconds in current time.
		 */
		getCurrentMs: function() {
			var now = new Date();
			return (now.valueOf());
		},

		/**
		*
		*/
		getAllComponents : function ()
		{
			//console.log ("getAllComponents ()");

			var result=[];
			//var index=0;

			$('.CTATComponent').each(function() {
				result.push($(this).data('CTATComponent'));
			});
			/*for (var CTATComponentType in CTAT.ComponentRegistry)
			{
				//console.log (CTATComponentType);
				var CTATComponent = CTAT.ComponentRegistry[CTATComponentType];

				// This walks the registered components, probably want to change to walking the dom.
				$('.'+CTATComponentType).each(function()
				{
					// for each component of the given class
					//console.log ("Pushing component ...");
					result [index]=($(this).data('CTATComponent'));
					index++;
				});
			}*/

			//console.log ("Found: " + result.length + " instances");

			return result;
		},

		/**
		 * Used to grab the component name from <value> tag in the SAI for
		 * grouped components such as radio buttons. This allows us to include
		 * colons in a group name (provided it is allowed in AS3).
		 */
		getNameFromGroup: function(nameLabelPair)
		{
			CTATShellTools.ctat_base.ctatdebug ("getNameFromGroup ("+nameLabelPair+")");

			var pair=nameLabelPair.split(" ");

			if (pair.length==1)
			{
				return (nameLabelPair);
			}

			return (pair[0].substring(0, pair[0].length-1));
		},

		/**
		 * aCompName is only needed for component groups such as radio buttons. We only
		 * get the name of the component group, which is only half useful. The actual
		 * component name is also needed.
		 * @returns {Array} a list of CTATComponents.
		 */
		findComponent: function (aName, aCompName)
		{
			var pointer = CTATShellTools.ctat_base;

			CTATShellTools.ctat_base.ctatdebug("findComponent("+aName+")");

			var components = CTATShellTools.component_descriptions;
			var groupArray=[];

			var jqn = null;

			if (aName.indexOf('.')>-1)
			{
				// use of dot notation to indicate membership confounds jQuery
				jqn = $('[id="'+aName+'"]');
			}
			else
			{
				jqn = $('#'+aName); // jQuery statement to get html generated components.
			}

			if (jqn.length>0)
			{
				// with #id, there should only be one.
				var els = [];
				jqn.each(function()
				{
					if ($(this).data('CTATComponent'))
					{
						els.push($(this).data('CTATComponent'));
					}
					// else // TODO: non-ctat component
				});

				if (els.length>0)
				{
					/*
					if (els.length==1)
					{
						return (els [0]);
					}
					*/

					return els;
				}
			}

			// find "group" for radio buttons and check boxes
			jqn = $('div[data-ctat-component]:has(input[name="'+aName+'"])');
			if (jqn.length>0)
			{
				var grp = [];
				jqn.each(function() {
					if ($(this).data('CTATComponent'))
						grp.push($(this).data('CTATComponent'));
				});

				if (grp.length>0)
					return grp;
			}

			// Check special names
			if (aName=="done") {
				var done_buttons = [];
				$('.CTATDoneButton').each(function() {
					if ($(this).data('CTATComponent'))
						done_buttons.push($(this).data('CTATComponent'));
				});
				if (done_buttons.length>0) return done_buttons;
			} else if (aName=="hint") {
				var hint_buttons = [];
				$('.CTATHintButton').each(function() {
					if ($(this).data('CTATComponent'))
						hint_buttons.push($(this).data('CTATComponent'));
				});
				if (hint_buttons.length>0) return hint_buttons;
			}

			CTATShellTools.ctat_base.ctatdebug("JQuery couldn't find the component, let's try our internal list ...");

			for (var i in components)
			{
				var aDesc=components [i];

				if (aDesc===null)
				{
					CTATShellTools.ctat_base.ctatdebug("Internal error parsing component at index " + i);
					return (null);
				}

				if (aDesc.name===null)
				{
					CTATShellTools.ctat_base.ctatdebug("Internal error parsing component at index " + i + " (no name attribute available)");
					return (null);
				}

				CTATShellTools.ctat_base.ctatdebug ("Comparing " + aDesc.name + " to: " + aName);

				if (aDesc.name==aName)
				{
					if (aDesc.getComponentPointer ()===null)
					{
						CTATShellTools.ctat_base.ctatdebug ("Internal error, found a component description for ["+aDesc.name+"], but component pointer is null");
						return (null);
					}

					CTATShellTools.ctat_base.ctatdebug ("Found a component description for ["+aDesc.name+"], returning pointer ("+aDesc.getComponentPointer ()+") ...");

					groupArray=[];
					groupArray.push (aDesc.getComponentPointer ());

					return (groupArray);
				}

				// Needed for things like radio buttons, and check boxes
				// In this case, aName is the group name, not component name
				if (aDesc.groupName==aName)
				{
					CTATShellTools.ctat_base.ctatdebug ("Found the component group ("+aDesc.groupName+"), adding component instance for " + aDesc.name+ " ...");

					groupArray.push (aDesc.getComponentPointer ());
				}
			}

			if (groupArray===null)
			{
				CTATShellTools.ctat_base.ctatdebug ("Info (groupArray==null), no appropriate component found, perhaps this is a group component");

				if (aName.indexOf (".")!=-1)
				{
					var splitter=aName.split (".");

					return (this.findComponent (splitter [0]));
				}

				return (groupArray);
			}

			if (groupArray.length===0)
			{
				CTATShellTools.ctat_base.ctatdebug ("Info (groupArray.length==0), no appropriate component found, perhaps this is a group component");

				if (aName.indexOf (".")!=-1)
				{
					var gsplitter=aName.split (".");

					return (this.findComponent (gsplitter [0]));
				}

				return (groupArray);
			}
			return (groupArray);
		},
		/**
		 * aCompName is only needed for component groups such as radio buttons. We only
		 * get the name of the component group, which is only half useful. The actual
		 * component name is also needed.
		 */
		findComponentInstance: function (aName, aCompName)
		{
			var result=CTATShellTools.findComponent (aName,aCompName);

			if (result.length==1)
			{
				return (result [0]);
			}

			return (result);
		},
		/**
		 *
		 */
		findComponentByClass: function findComponentByClass (aClass)
		{
			var pointer = CTATShellTools.ctat_base;
			//pointer.ctatdebug("findComponentByClass("+aClass+")");

			var components = CTATShellTools.component_descriptions;

			for (var i in components)
			{
				var aDesc=components [i];

				if (aDesc===null)
				{
					//pointer.ctatdebug ("Internal error parsing component at index " + i);
					return (null);
				}

				if (aDesc.getComponentPointer ()!==null)
				{
					if (aDesc.getComponentPointer ().getClassName ()==aClass)
					{
						//pointer.ctatdebug ("Found a component description, returning pointer ...");

						return (aDesc.getComponentPointer ());
					}
				}
			}
			var jqnode = $('.'+aClass);
			if (jqnode.length>0) {
				return jqnode.first().data('CTATComponent');
			}

			return (null);
		},
};

//CTATShellTools.prototype = Object.create(CTATBase.prototype);
//CTATShellTools.prototype.constructor = CTATShellTools;
