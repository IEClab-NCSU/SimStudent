/**-----------------------------------------------------------------------------
 $Author$
 $Date$
 $HeadURL$
 $Revision$

 -
 License:
 -
 ChangeLog:
 -
 Notes:

 */

goog.provide('CTATWorkedExamplePlayer');

goog.require('CTAT.Component.Base.Graphical');
goog.require('CTATBinaryImages');
goog.require('CTATComplexSAI');
goog.require('CTATCommShell');
goog.require('CTATGlobalFunctions');

CTATWorkedExamplePlayer = function(aDescription,
								  aX,
								  aY,
								  aWidth,
								  aHeight)
{
	CTAT.Component.Base.Graphical.call(this,
					  //aClassName,
					  //aName,
					  aDescription,
					  aX,
					  aY,
					  aWidth,
					  aHeight);
	var pointer=this;

	var buttonBack=null;
	var buttonStop=null;
	var buttonForward=null;
	var playLocation=null;

	var playIndex=0;
	var messageTank=null;
	var player=null;

	var buttoning=false;

	this.ctatdebug (this.getClassName() + " ("+this.getX()+","+this.getY()+","+this.getWidth()+","+this.getHeight()+")");

	/**
	*
	*/
	this.init=function init()
	{
	    pointer.ctatdebug("init (" + pointer.getName() + ")");

		pointer.setCanvasVisibility("visible");
	    pointer.addCSSAttribute("z-index", CTATGlobalFunctions.gensym.z_index());
		pointer.addCSSAttribute("pointer-events",'none');

	    pointer.ctatdebug("Final location: " + pointer.getX() + "," + pointer.getY() + " with text: " + pointer.getText());

	    pointer.setInitialized(true);
	};

	/**
	*
	*/
	this.construct=function construct()
	{
	    pointer.ctatdebug("construct (" + pointer.getName() + ")");

		var playLabelWidth=90;
		var wdiv=((pointer.getWidth ()-playLabelWidth)/3);
		wdiv+=2; // add padding

		var ind=CTATGlobalFunctions.gensym.z_index();
		var left=2;

	    buttonBack=new Image();
	    buttonBack.setAttribute('id', CTATGlobalFunctions.gensym.div_id());
	    buttonBack.setAttribute('onkeypress', 'return noenter(event)');
		buttonBack.src=CTATBinaryImages.buttonBackURL;
		buttonBack.setAttribute('style', 'position: absolute; left: '+left+'px; top: 4px; z-index: ' + ind);
		buttonBack.onclick = pointer.processButtonBack;
		pointer.getDivWrap().appendChild(buttonBack);

		ind=CTATGlobalFunctions.gensym.z_index();
		left+=wdiv;

	    buttonStop=new Image();
	    buttonStop.setAttribute('id', CTATGlobalFunctions.gensym.div_id());
	    buttonStop.setAttribute('onkeypress', 'return noenter(event)');
		buttonStop.src=CTATBinaryImages.buttonReloadURL;
		buttonStop.setAttribute('style', 'position: absolute; left: '+left+'px; top: 4px; z-index: ' + ind);
		buttonStop.onclick = pointer.processButtonStop;
		pointer.getDivWrap().appendChild(buttonStop);

		ind=CTATGlobalFunctions.gensym.z_index();
		left+=wdiv;

	    playLocation=document.createElement('div');
	    playLocation.setAttribute('id', CTATGlobalFunctions.gensym.div_id());
	    playLocation.setAttribute('onkeypress', 'return noenter(event)');
		playLocation.setAttribute('style', 'overflow:hidden; position: absolute; left: '+left+'px; top: 4px; width: '+playLabelWidth+'px; height: 56px; font-size:19pt; font-family: verdana; font-weight:bold; color:#444444; border: 1px solid #cccccc;text-align: center; vertical-align: middle; line-height: 56px; z-index: ' + ind);
		playLocation.innerHTML="0/0";
	    pointer.getDivWrap().appendChild(playLocation);

		ind=CTATGlobalFunctions.gensym.z_index();
		left+=(playLabelWidth+4);

		buttonForward=new Image();
	    buttonForward.setAttribute('id', CTATGlobalFunctions.gensym.div_id());
	    buttonForward.setAttribute('onkeypress', 'return noenter(event)');
		buttonForward.src=CTATBinaryImages.buttonForwardURL;
		buttonForward.setAttribute('style', 'position: absolute; left: '+left+'px; top: 4px; z-index: ' + ind);
		buttonForward.onclick = pointer.processButtonForward;
		pointer.getDivWrap().appendChild(buttonForward);

		pointer.ctatdebug("construct (" + pointer.getName() + ") done");
	};

	/**
	*
	*/
	this.processButtonBack=function processButtonBack ()
	{
		pointer.ctatdebug("processButtonBack ("+playIndex+")");

		if (buttoning==true)
		{
			return;
		}

		buttoning=true;

		if (playIndex==0)
		{
			//console.log ("We're already at the start, bump");
			buttoning=false;
			return;
		}

		if (messageTank==null)
		{
			pointer.ctatdebug("Error: pointer to message tank is null");
			buttoning=false;
			return;
		}

		if (CTATCommShell.commShell==null)
		{
			pointer.ctatdebug("Error: commShell is null");
			buttoning=false;
			return;
		}

		buttonForward.src=CTATBinaryImages.buttonForwardURL;

		var aMessage=messageTank [playIndex];

		if (aMessage!=null)
		{
			//console.log ("(Back, Step 1) Processing index " + playIndex + " out of ("+(messageTank.length-1)+") -> " + aMessage.getSelection ());
			var tempAction=aMessage.getAction ();
			aMessage.setAction ("reset");
			CTATCommShell.commShell.processInterfaceAction (aMessage);
			aMessage.setAction (tempAction);
		}

		playIndex--;

		if (playIndex<=0)
		{
			playIndex=0;
			buttonBack.src=CTATBinaryImages.buttonBackURLDisabled;
		}
		else
		{
			buttonBack.src=CTATBinaryImages.buttonBackURL;
		}

		pointer.showPlayIndex ();

		var bMessage=messageTank [playIndex];

		if (bMessage!=null)
		{
			//console.log ("(Back, Step 2) Processing index " + playIndex + " out of ("+(messageTank.length-1)+") -> " + bMessage.getSelection ());
			pointer.ctatdebug ("Create a complex SAI and configure it to represent the hint button pressed");
			var hintSAI = new CTATComplexSAI ("hint", "ButtonPressed", "hint request");
			pointer.ctatdebug ("Add the current selection to the fake hint requests");
			hintSAI.addSelectionActionInput(bMessage.getSelection(), "PreviousFocus");
			pointer.ctatdebug ("Mechanically ask for a hint ...");
			CTATCommShell.commShell.processComponentAction (hintSAI);
		}

		buttoning=false;
	};

	/**
	*
	*/
	this.processButtonForward=function processButtonForward ()
	{
		pointer.ctatdebug("processButtonForward ()");

		if (buttoning==true)
		{
			pointer.ctatdebug("buttoning==true, bump");
			return;
		}

		buttoning=true;

		if (playIndex==(messageTank.length-1))
		{
			//console.log ("Already at the end");
			buttoning=false;
			return;
		}

		if (messageTank==null)
		{
			pointer.ctatdebug("Error: pointer to message tank is null");
			buttoning=false;
			return;
		}

		if (CTATCommShell.commShell==null)
		{
			pointer.ctatdebug("Error: commShell is null");
			buttoning=false;
			return;
		}

		playIndex++;

		buttonBack.src=CTATBinaryImages.buttonBackURL;

		if (playIndex>=(messageTank.length-1))
		{
			playIndex=(messageTank.length-1);

			buttonForward.src=CTATBinaryImages.buttonForwardURLDisabled;
		}
		else
		{
			buttonForward.src=CTATBinaryImages.buttonForwardURL;
		}

		pointer.showPlayIndex ();

		var aMessage=messageTank [playIndex];

		pointer.ctatdebug ("(Forward) Processing index " + playIndex + " out of ("+(messageTank.length-1)+") -> " + aMessage.getSelection ());

		if (aMessage!=null)
		{
			// Execute the SAI first directly on the CommShell

			CTATCommShell.commShell.processInterfaceAction (aMessage);

			pointer.ctatdebug ("Create a complex SAI and configure it to represent the hint button pressed");

			// Note: convert SAI to Complex SAI

			var hintSAI = new CTATComplexSAI ("hint", "ButtonPressed", "hint request");

			pointer.ctatdebug ("Add the current selection to the fake hint requests");

			hintSAI.addSelectionActionInput(aMessage.getSelection(), "PreviousFocus");

			pointer.ctatdebug ("Mechanically ask for a hint ...");

			CTATCommShell.commShell.processComponentAction (hintSAI);

			//CTATCommShell.commShell.showHighlightSelection (aMessage.getSelection());
		}
		else
		{
			pointer.ctatdebug("Error: retrieved message is null.");
		}

		buttoning=false;
	};

	/**
	*
	*/
	this.processButtonStop=function processButtonStop ()
	{
		pointer.ctatdebug("processButtonStop ()");

		if (messageTank==null)
		{
			pointer.ctatdebug("Error: pointer to message tank is null");
			return;
		}

		playIndex=0;

		var aMessage=messageTank [playIndex];

		pointer.ctatdebug ("(Stop) Processing index " + playIndex + " out of ("+(messageTank.length-1)+") -> " + aMessage.getSelection ());

		buttonBack.src=CTATBinaryImages.buttonBackURLDisabled;
		buttonForward.src=CTATBinaryImages.buttonForwardURL;

		if (aMessage!=null)
		{
			// Execute the SAI first directly on the CommShell

			clearSheet ();

			CTATCommShell.commShell.processInterfaceAction (aMessage);

			pointer.ctatdebug ("Create a complex SAI and configure it to represent the hint button pressed");

			// Note: convert SAI to Complex SAI

			var hintSAI = new CTATComplexSAI ("hint", "ButtonPressed", "hint request");

			pointer.ctatdebug ("Add the current selection to the fake hint requests");

			hintSAI.addSelectionActionInput(aMessage.getSelection(), "PreviousFocus");

			pointer.ctatdebug ("Mechanically ask for a hint ...");

			CTATCommShell.commShell.processComponentAction (hintSAI);

			//CTATCommShell.commShell.showHighlightSelection (aMessage.getSelection());
		}
		else
		{
			pointer.ctatdebug("Error: retrieved message is null.");
		}

		pointer.showPlayIndex ();
	};

	/**
	*
	*/
	this.processMessageTank=function processMessageTank (aMessageTank)
	{
		pointer.ctatdebug("processMessageTank ()");

		messageTank=new Array ();

		for (var i=0;i<aMessageTank.length;i++)
		{
			var aMessage=aMessageTank [i];

			pointer.ctatdebug("Processing: " + aMessage.getMessageType ());

			if (aMessage.getMessageType ()=="InterfaceAction")
			{
				messageTank.push (aMessage);
			}
			else
			{
				pointer.ctatdebug ("Skipping " + aMessage.getMessageType () + " for message tank");
			}
		}
	};
	/**
	*
	*/
	this.processStartStateActions=function processStartStateActions (aMessageTank)
	{
		pointer.ctatdebug("processStartStateActions ()");

		if (aMessageTank==null)
		{
			pointer.ctatdebug("Error: provided message tank is null");
			return;
		}

		pointer.processMessageTank (aMessageTank);

		var aMessage=messageTank [playIndex];

		CTATCommShell.commShell.processInterfaceAction (aMessage);

		pointer.ctatdebug ("Create a complex SAI and configure it to represent the hint button pressed");

		var hintSAI = new CTATComplexSAI ("hint", "ButtonPressed", "hint request");

		pointer.ctatdebug ("Add the current selection to the fake hint requests");

		hintSAI.addSelectionActionInput(aMessage.getSelection(), "PreviousFocus");

		pointer.ctatdebug ("Mechanically ask for a hint ...");

		CTATCommShell.commShell.processComponentAction (hintSAI);

		buttonBack.src=CTATBinaryImages.buttonBackURLDisabled;

		pointer.showPlayIndex ();
	};

	/**
	*
	*/
	this.showPlayIndex=function showPlayIndex ()
	{
		pointer.ctatdebug("showPlayIndex ()");

		/*
		if (playIndex==0)
		{
			playLocation.innerHTML="";
			return;
		}
		*/

		if (messageTank==null)
		{
			playLocation.innerHTML="0/0";
			return;
		}

		if (messageTank.length==0)
		{
			playLocation.innerHTML=("0/0");
			return;
		}

		playLocation.innerHTML=((playIndex+1) + "/" + messageTank.length);
	};
	/**
	*
	*/
	this.getComponentFromQueue=function getComponentFromQueue (anIndex)
	{
		pointer.ctatdebug ("getComponentFromQueue ("+anIndex+")");

		var aMessage=messageTank [playIndex];

		if (aMessage!=null)
		{
			debug ("Examining message with type: " + aMessage.getMessageType());

			var sel=aMessage.getSelection();

			debug ("Finding component with instance name: " + sel);

			var tools=new CTATShellTools ();

			var comp=tools.findComponent (sel);

			return (comp);
		}

		return (null);
	};
};

CTATWorkedExamplePlayer.prototype = Object.create(CTAT.Component.Base.Graphical.prototype);
CTATWorkedExamplePlayer.prototype.constructor = CTATWorkedExamplePlayer;
