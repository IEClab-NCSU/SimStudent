/**-----------------------------------------------------------------------------
 $Author$
 $Date$
 $HeadURL$
 $Revision$

 -
 License:
 -
 ChangeLog:
 -
 Notes:

 */
goog.provide('CTATRadioButton');

goog.require('CTATGlobals');
goog.require('CTATGlobalFunctions');
goog.require('CTAT.Component.Base.Clickable');
goog.require('CTAT.ComponentRegistry');
goog.require('CTATSAI');
goog.require('CTATShellTools');

CTATRadioButton = function(aDescription, aX, aY, aWidth, aHeight)
{
	CTAT.Component.Base.Clickable.call(this,
			"CTATRadioButton",
			"__undefined__",
			aDescription,
			aX,
			aY,
			aWidth,
			aHeight);
	var previewMode = CTATConfiguration.get('previewMode');
	var pointer=this;
	var radiobutton=null;
	var label=null;
	var color='#000000';
	this.setSelection(this.getComponentGroup());
	this.setAction('UpdateRadioButton');

	// Do not respect the following SUI styles
	this.setStyleHandler('BackgroundColor',null); // do not respect background color SUI setting

	this.init=function init()
	{
		pointer.setInitialized(true);
		radiobutton=document.createElement('input');
		radiobutton.type='radio';
		radiobutton.id = this.getName()+'_radio';
		radiobutton.value=pointer.getName();
		if (this.getComponentGroup())
			radiobutton.name=pointer.getComponentGroup();
		else if (this.getDivWrap() && $(this.getDivWrap()).attr('name'))
			radiobutton.name=$(this.getDivWrap()).attr('name');
		else
			radiobutton.name='radioButtonGroup';

		if (pointer.getEnabled()===true)
			radiobutton.disabled=false;
		else
			radiobutton.disabled=true;

		pointer.addComponentReference(pointer, radiobutton);
		var content;
		if (!previewMode)
		{
			content = this.getDivWrap().innerHTML;
			this.getDivWrap().innerHTML = '';
		}
		pointer.getDivWrap().appendChild(radiobutton);
		label = document.createElement('label');
		label.htmlFor = radiobutton.id;
		if (this.getText())
			label.textContent=pointer.getText();
		else if (content && !previewMode)
			label.innerHTML = content;
		else if (this.getDivWrap().getAttribute('data-ctat-label'))
			label.textContent = this.getDivWrap().getAttribute('data-ctat-label');
		pointer.setComponent(radiobutton);

		this.getDivWrap().appendChild (label);

		radiobutton.addEventListener ('click',function(e) {
			pointer.updateSAI();
			pointer.processAction();
		});
		radiobutton.addEventListener('focus', this.processFocus);
		radiobutton.onfocus=this.processOnFocus; // as the div is the component, need to add the onfocus handler which is normally done by processTabOrder.
		this.setSelection(this.getComponentGroup()); // fix for CTATTutor calling setName
	    this.component.addEventListener('focus', this.processFocus);
	};
	/**
	 * This is run during the generation of InterfaceDescription messages and
	 * it generates interface actions for options set by the author in the
	 * html code.
	 * @returns {Array<CTATSAI>} of SAIs.
	 */
	this.getConfigurationActions = function () {
		var actions = [];
		if (label.innerHTML.trim().length>0) {
			var sai = new CTATSAI();
			sai.setSelection(this.getName()); // make sure it is id and not group
			sai.setInput(label.innerHTML.toString());
			sai.setAction('setText');
			actions.push(sai);
		}
	    return actions;
	};

	this.setFontColor = function(aColor)
	{
		color = aColor;
		$(label).css('color', aColor);
	}
	
	this.getFontColor = function()
	{
		return color;
	}
	
	this.resize = function()
	{
		var height = $(this.getDivWrap()).height();
		$(label).css('font-size', (height-5)+'px');
		$(this.getComponent()).css('height', (height-10)+'px');
		$(this.getComponent()).css('width', (height-10)+'px');
	}
	
	var super_setText = this.setText;
	this.setText=function setText (aText)
	{
		super_setText(aText);

		if (label!==null)
		{
			label.innerHTML=this.getText();
		}
	};
	this.setStyleHandler("buttonLabel",this.setText);

	var super_setEnabled = this.setEnabled;
	/**
	 * Extend setEnabled to properly disable the radio button.
	 * @see {@link CTATCompBase}
	 */
	this.setEnabled=function setEnabled(aValue)
	{
		super_setEnabled(aValue);
		if (radiobutton===null)
			return;

		radiobutton.disabled=!this.getEnabled();
	};

	this.setChecked=function setChecked(aValue)
	{
		if (radiobutton===null)
			return;

		radiobutton.checked=aValue;
	};

	this.getChecked=function getChecked()
	{
		return (radiobutton.checked);
	};

	//SAI Input
	this.getRadioInput=function getRadioInput ()
	{
		if (radiobutton.checked)
			return (radiobutton.value+": "+label.textContent);
		else
			return '';
	};

	this.setStyleHandler("labelPlacement",null);// set with CSS

	this.reset=function reset ()
	{
		pointer.ctatdebug (" reset ( " + pointer.getName () + ")");

		radiobutton.checked=false;
		pointer.setEnabled(true);
	};

	/**
	 * TPA
	 */
	this.UpdateRadioButton=function UpdateRadioButton (selection)
	{

		if (selection.indexOf(radiobutton.value)>=0) {
			pointer.setChecked(true);
		}
		pointer.ctatdebug ("UpdateRadioButton ()");
	};
	this.updateSAI = function () {
		var radios = $('div[data-ctat-component]:has(input[type="radio"][name="'+radiobutton.name+'"]:checked)');
		var input = '';
		if (radios.length===1) {
			input = $(radios[0]).data('CTATComponent').getRadioInput();
		}
		pointer.setSelection(radiobutton.name); // CTATTutor calls setName
		pointer.setInput(input);
	};

	var add_highlighting = function(h) {
		if (label) label.classList.add(h);
		if (radiobutton) radiobutton.classList.add(h);
	};
	var remove_highlighting = function(h) {
		if (label) label.classList.remove(h);
		if (radiobutton) radiobutton.classList.remove(h);
	};
	this.showCorrect = function(aSAI) {
		remove_highlighting('CTAT--hint');
		remove_highlighting('CTAT--incorrect');
		if (aSAI?aSAI.getInput().indexOf(radiobutton.value)===0:true)
			add_highlighting('CTAT--correct');
		else
			remove_highlighting('CTAT-correct');
	};
	this.removeCorrect = function() {
		remove_highlighting('CTAT--correct');
	};
	this.showInCorrect = function(aSAI) {
		remove_highlighting('CTAT--hint');
		remove_highlighting('CTAT--correct');
		if (aSAI?aSAI.getInput().indexOf(radiobutton.value)===0:true)
			add_highlighting('CTAT--incorrect');
		else
			remove_highlighting('CTAT-incorrect');
	};
	this.removeInCorrect = remove_highlighting.bind(this,'CTAT--incorrect');
	this.showHintHighlight = function(pHint) {
		this.removeCorrect();
		this.removeInCorrect();
		if (pHint) {
			add_highlighting('CTAT--hint');
		} else {
			remove_highlighting('CTAT--hint');
		}
	};

};

CTATRadioButton.prototype = Object.create(CTAT.Component.Base.Clickable.prototype);
CTATRadioButton.prototype.constructor = CTATRadioButton;

CTAT.ComponentRegistry.addComponentType('CTATRadioButton',CTATRadioButton);
