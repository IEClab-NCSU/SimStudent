/**-----------------------------------------------------------------------------
 $Author$
 $Date$
 $HeadURL$
 $Revision$

 -
 License:
 -
 ChangeLog:
 -
 Notes:

	http://quocity.com/colresizable/

 */
goog.provide('CTATTable');

goog.require('CTAT.Component.Base.Graphical');
goog.require('CTATGlobalFunctions');
goog.require('CTATGlobals');
goog.require('CTATShellTools');
goog.require('CTATTextArea');
//goog.require('CTATTextField');
//goog.require('CTATTextInput');
goog.require('CTAT.ComponentRegistry');
/**
 *
 */
CTATTable = function(aDescription,aX,aY,aWidth,aHeight)
{
	CTAT.Component.Base.Tutorable.call(this,
			"CTATTable",
			"__undefined__",
			aDescription,
			aX,
			aY,
			aWidth,
			aHeight);

	var pointer=this;
	var cells = []; //internal array of all cells
	var rows = []; //internal array of all rows
	/***************** Parameters ********************/
	var header_row = 0;
	this.get_first_row_is_header = function () {
		return CTATGlobalFunctions.toBoolean($(this.getDivWrap()).attr('data-ctat-has-header'));
	};
	this.set_first_row_is_header = function (aBool) {
		$(this.getDivWrap()).attr('data-ctat-has-header',aBool);
		if (this.get_first_row_is_header()) {
			fix_header();
			header_row = 1;
		} else {
			remove_header();
			header_row = 0;
		}
	};
	this.setParameterHandler('FirstRowIsHeader', this.set_first_row_is_header);

	var get_count = function(attribute) {
		var count = parseInt($(this.getDivWrap()).attr(attribute));
		return isNaN(count)? 2 : count;
	};
	//---num-rows---//
	var get_row_count = get_count.bind(this, 'data-ctat-num-rows');
	this.get_row_count = get_row_count;
	this.set_row_count = function(nRows) {
		$(this.getDivWrap()).attr('data-ctat-num-rows',nRows);
	};
	this.setNumRows = function(nRows) {
		var newRows = Number(nRows);
		if (!isNaN(newRows)) {
			while (this.get_row_count()<newRows) {
				this.addRow();
			}
			while (this.get_row_count()>newRows) {
				this.deleteRow();
			}
		}
	};
	//---num-cols---//
	var get_col_count = get_count.bind(this, 'data-ctat-num-cols');
	this.get_col_count = get_col_count;
	this.set_col_count = function(nCols) {
		$(this.getDivWrap()).attr('data-ctat-num-cols',nCols);
	};
	this.setNumCols = function(nCols) {
		var newCols = Number(nCols);
		if (!isNaN(newCols)) {
			while (this.get_col_count()<newCols) {
				this.addColumn();
			}
			while (this.get_col_count()>newCols) {
				this.deleteColumn();
			}
		}
	};

	this.super_setName = this.setName;

	this.setName = function(aName)
	{
		this.super_setName(aName);
		if (cells && cells[0])
		{
			for (var i = 0; i < cells.length; i++)
			{
				for (var j = 0; j < cells[0].length; j++)
				{
					cells[i][j].setAttribute('id', aName+'.R'+i+'C'+j);
				}
			}
		}
	}

	/**
	 *	Creates table html element and styles according to dimensions of div wrapper
	 *	Inits row and col count, then calls adjustTableContents() to generate inner components
	 */
	this.init=function init()
	{
		pointer.ctatdebug("init (" + pointer.getName() + ")");

		pointer.setInitialized(true);
		var divWrap = pointer.getDivWrap();
		pointer.setComponent(divWrap);
		pointer.addComponentReference(pointer, divWrap);

		pointer.render();
		
		console.log("table name = "+this.getName());
		
		//build table
		this.adjustTableContents();
		//generate table header (if needed)
		if (this.get_first_row_is_header()) {
			fix_header();
			header_row = 1;
		} else header_row = 0;
	};
	
	this.getConfigurationActions = function () {
		var actions = [];
		var sai;
		var $div = $(this.getDivWrap());
		if ($div.attr('data-ctat-num-rows')) {
			sai = new CTATSAI();
			sai.setSelection(this.getName());
			sai.setAction('setNumRows');
			sai.setInput($div.attr('data-ctat-num-rows'));
			actions.push(sai);
		}
		if ($div.attr('data-ctat-num-cols')) {
			sai = new CTATSAI();
			sai.setSelection(this.getName());
			sai.setAction('setNumCols');
			sai.setInput($div.attr('data-ctat-num-cols'));
			actions.push(sai);
		}
		if ($div.attr('data-ctat-has-header')) {
			sai = new CTATSAI();
			sai.setSelection(this.getName());
			sai.setAction('set_first_row_is_header');
			sai.setInput($div.attr('data-ctat-has-header'));
			actions.push(sai);
		}
		return actions;
	};
	
	var fix_header = function() {
		console.log('fix header');
		rows[0].classList.add('CTATTable--headers');
		for (let i = 0; i < cells[0].length; i++)
		{
			cells[0][i].classList.add('CTATTable--header');
		}
	}.bind(this);
	var remove_header = function() {
		console.log('remove header');
		rows[0].classList.remove('CTATTable--headers');
		for (let i = 0; i < cells[0].length; i++)
		{
			cells[0][i].classList.remove('CTATTable--header');
		}
	}.bind(this);
	this.fixHeader = fix_header;
	this.removeHeader = remove_header;
	
	var make_cell = function(row,col) {
		var cell = document.createElement('div');
		var compName = this.getName()+".R"+row+"C"+col;
		cell.id = compName;
		cell.classList.add('CTATTable--cell');
		cell.classList.add('CTATTextArea');
		//$(cell).css('height', '100%');
		var ta = new CTATTextArea();
		ta.setName(compName);
		ta.setDivWrapper(cell);
		ta.processAttributes();
		ta.init(true);
		ta.processTabOrder();
		ta.setEnabled(this.getEnabled());
		$(cell).data('CTATComponent',ta);
		return cell;
	}.bind(this);

	/**
	 * Adds a new row to the end of the table
	 * Cell height will decrease or table height will increase,
	 * depending on whether 'expandable' is false or true, respectively
	 **/
	this.addRow = function ()
	{
		var rowdiv = document.createElement('div');
		rowdiv.classList.add('CTATTable--row');
		var row = get_row_count();
		var rowInt = parseInt(row, 10);
		cells[row] = [];
		for (var col=0; col < get_col_count(); col++) {
			var cell = make_cell(row,col);
			cells[row].push(cell);
			rowdiv.appendChild(cell);
		}
		$(this.getDivWrap()).append(rowdiv);
		rows.push(rowdiv);
		this.set_row_count(row+1);
	};
	
	this.deleteRow = function()
	{
		var divWrap = this.getDivWrap();
		divWrap.removeChild(divWrap.lastChild);
		rows.pop();
		cells.pop();
		this.set_row_count(this.get_row_count()-1);
	}

	/**
	 * Adds a new column to the end of the table
	 * Cell width will decrease or table width will increase,
	 * depending on whether 'expandable' is false or true, respectively
	 */
	this.addColumn = function ()
	{
		var col = get_col_count();
		var row = 0;
		rows.forEach(function (thisRow) {
			var cell = make_cell(row,col);
			cells[row].push(cell);
			if (row < header_row) {
				cell.classList.add('CTATTable--header');
			}
			thisRow.appendChild(cell);
			row++;
		});
		this.set_col_count(col+1);
	};
	
	this.deleteColumn = function()
	{
		var divWrap = this.getDivWrap();
		var numRows = rows.length;
		for (var i = 0; i < numRows; i++)
		{
			rows[i].removeChild(rows[i].lastChild);
			cells[i].pop();
		}
		this.set_col_count(this.get_col_count()-1);
	};
	
	/**
	 * This method is called from CTATTutor in postProcess and will grab all
	 * the separate text input components and reparents them in the appropriate
	 * table cells.
	 *
	 * Uses http://quocity.com/colresizable/
	 */
	this.adjustTableContents=function adjustTableContents ()
	{
		pointer.ctatdebug ("adjustTableContents()");
		var rowCnt = get_row_count();
		for (var row=0; row < rowCnt; row++) {
			var rowdiv = document.createElement('div');
			rowdiv.classList.add('CTATTable--row');
			$(this.getDivWrap()).append(rowdiv);
			rows.push(rowdiv);
			for (var col=0; col < get_col_count(); col++) {
				var compName = pointer.getName()+".R"+row+"C"+col;
				var comp = CTATShellTools.findComponent(compName);
				var compElement;
				if (!comp || comp.length === 0 || comp[0].getName() !== compName)
				{
					//gen new component if one doesn't exist for that cell
					compElement = make_cell(row,col);
					rowdiv.appendChild(compElement);
				}
				else
				{
					//else just add existing input comp to new cell
					compElement = comp[0].getDivWrap();
					compElement.classList.add('CTATTable--cell');
					rowdiv.appendChild(compElement);
				}
				if (!cells[row])
					cells[row] = [];
				cells[row].push(compElement);
			}
		}
	};
};

CTATTable.prototype = Object.create(CTAT.Component.Base.Graphical.prototype);
CTATTable.prototype.constructor = CTATTable;

CTAT.ComponentRegistry.addComponentType('CTATTable',CTATTable);