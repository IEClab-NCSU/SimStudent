/**-----------------------------------------------------------------------------
 $Author$
 $Date$
 $HeadURL$
 $Revision$

 -
 License:
 -
 ChangeLog:
 -
 Notes:

 */
goog.provide('CTATHintWindow');

goog.require('CTAT.Component.Base.Graphical');
goog.require('CTATCommShell');
goog.require('CTATConfig');
goog.require('CTATGlobalFunctions');
goog.require('CTATGlobals');
goog.require('CTATGuid');
goog.require('CTATJSON');
goog.require('CTATShellTools');
goog.require('CTAT.ComponentRegistry');
goog.require('CTATLanguageManager');
goog.require('CTATTutorMessageBuilder');
goog.require('CTATXML');

/**
 *
 */
CTATHintWindow = function(aDescription,aX,aY,aWidth,aHeight)
{
	CTAT.Component.Base.Graphical.call(this,
			"CTATHintWindow",
			"__undefined__",
			aDescription,
			aX,
			aY,
			aWidth,
			aHeight);

	var pointer=this;
	pointer.isTabIndexable=false;
	var messageParser = (CTATConfig.parserType_is_XML() ? new CTATXML () : new CTATJSON ());
	var assocRulesBuilder = new CTATTutorMessageBuilder();
	var hintContent=null;
	var previous=null;
	var next=null;
	var hintwindow=null;
	var _next_text = CTATGlobals.languageManager.getString ("NEXT"); // TODO: need Style/Parameter Handler
	var _previous_text = CTATGlobals.languageManager.getString ("PREVIOUS");

	var _next_content = null;
	this.data_ctat_handlers['next-content'] = function(content) {
		_next_content = content;
		if (next) next.innerHTML = content;
	};
	var _previous_content = null;
	this.data_ctat_handlers['previous-content'] = function(content) {
		_previous_content = content;
		if (previous) previous.innerHTML = content;
	};

	this.getCurrentHint=function getCurrentHint ()
	{
		return (hintContent.innerHTML);
	};
	/**
	 *
	 */
	this.init=function init()
	{
		pointer.ctatdebug("init (" + pointer.getName() + ")");

		pointer.setInitialized(true);
		pointer.setIsAbstractComponent (true);

		hintwindow=this.getDivWrap();
		if (!hintwindow.id)
			hintwindow.setAttribute('id', CTATGlobalFunctions.gensym.div_id());
		hintwindow.setAttribute('onkeypress', 'return noenter(event)');
		pointer.setComponent(hintwindow);

		pointer.addComponentReference(pointer, hintwindow);

		//> ------------- Hintwindow specific code ----------------------------
		hintContent = document.createElement('div');
		hintwindow.appendChild(hintContent);
		hintContent.classList.add('CTATHintWindow--hint-content');
		//hintContent.setAttribute('pointer-events','none');

		//> ------------- Hint Button Box -------------------------------------
		var hintButtons = document.createElement('div');
		hintButtons.classList.add('CTATHintWindow--hint-button-area');
		hintwindow.appendChild(hintButtons);

		//> ------------- Previous button specific code -----------------------
		if (_previous_content) {
			previous = document.createElement('button');
			previous.classList.add('CTATHintWindow--previous');
			previous.innerHTML = _previous_content;
		} else {
			previous = document.createElement('button');
			previous.classList.add('CTATHintWindow--previous');
			var larrow = document.createElement('span');
			larrow.classList.add('CTATHintWindow--button-icon');
			larrow.textContent = '\u25c0'; //'\u2b9c ';//'\u2BC7  '; //'\u279C'; //'\u2B05';//
			previous.appendChild(larrow);
			if (_previous_text) {
				larrow.style.cssFloat = 'left';
				previous.appendChild(document.createTextNode(_previous_text));
			}
		}
		previous.addEventListener('click', function(e) {
			CTATShellTools.showPrevHint();
		}, false);
		hintButtons.appendChild(previous);

		//> ------------- Next specific code ---------------------------------------
		if (_next_content) {
			next = document.createElement('button');
			next.classList.add('CTATHintWindow--next');
			next.innerHTML = _next_content;
		} else {
			next = document.createElement('button');
			next.classList.add('CTATHintWindow--next');
			var rarrow = document.createElement('span');
			rarrow.classList.add('CTATHintWindow--button-icon');
			rarrow.textContent = '\u25b6'; //'\u2b9e'; //'\u2BC8';//'\u279C';//'\u2B95';//
			if (_next_text) {
				rarrow.style.cssFloat = 'right';
				next.appendChild(document.createTextNode(_next_text));
			}
			next.appendChild(rarrow);
		}
		next.addEventListener('click', function(e) {
			CTATShellTools.showNextHint();
		}, false);
		hintButtons.appendChild(next);

		var setButtonEnabled = function(pEnabled) {
			this.disabled = !pEnabled;
			if (!pEnabled) {
				this.classList.remove('CTAT-hint-button--hover'); // make sure to clear other effects
				this.classList.remove('CTAT-hint-button--clicked');
			}
		};
		[previous, next].forEach(function(nav_button) {
			/* Add setEnabled method */
			nav_button.setEnabled = setButtonEnabled.bind(nav_button);
			nav_button.classList.add('CTATHintWindow--button'); // base hint window button class
			nav_button.classList.add('CTAT-hint-button'); // hint button class for colors
			// use mouseenter because :hover does not work well with disabling
			nav_button.addEventListener('mouseenter', function(e) {
				e.target.classList.add('CTAT-hint-button--hover');
			});
			nav_button.addEventListener('mouseleave', function(e) {
				e.target.classList.remove('CTAT-hint-button--hover');
				e.target.classList.remove('CTAT-hint-button--clicked'); // can remove Clicked as it has no visual effect
			});
			nav_button.addEventListener('mousedown', function(e) {
				e.target.classList.add('CTAT-hint-button--clicked');
			});
			nav_button.addEventListener('mouseup', function(e) {
				e.target.classList.remove('CTAT-hint-button--clicked');
			});
			nav_button.addEventListener('click', function(e) {
				e.target.classList.remove('CTAT-hint-button--clicked');
			});
		});

		//> ------------------------------------------------------------------------

		CTATShellTools.registerFeedbackComponent(this, this.goNext, this.goPrevious, this.showHint, this.showFeedback);

		pointer.ctatdebug("Disabling previous and next ...");

		previous.setEnabled (false);
		next.setEnabled (false);
	};
	/**
	 *
	 */
	this.setStyleHandler("OuterBorderColor",this.setBorderColor);

	/**
	 *
	 */
	this.showFeedback=function showFeedback (aMessage)
	{
		pointer.ctatdebug("showFeedback ("+aMessage+")");

		if (hintContent)
		{
			hintContent.innerHTML = (CTATGlobals.languageManager.filterString (aMessage));
		}

		previous.setEnabled (false);
		next.setEnabled (false);
	};
	/**
	 * An Interface Action for setting what is displayed in the hint window.
	 * @param {string} message
	 * @see CTATHintWindow.showFeedback
	 */
	this.SetText = this.showFeedback;
	/**
	 *
	 * @param hintList
	 */
	this.showHint=function showHint (hintList)
	{
		pointer.ctatdebug("showHint ()");
		hints = hintList;
		hintIndex=0;
		previous.setEnabled (false);
		next.setEnabled (false);
		if (!hints)
		{
			hints=[];
			hintContent.innerHTML = "";
			return;
		}

		this.setEnabled (true);

		if (hints [hintIndex]==="") // TODO: Should this be trimmed?
		{
			pointer.ctatdebug("Empty hint in list, bump");
			return;
		}

		hintContent.innerHTML = (CTATGlobals.languageManager.filterString (hints [hintIndex])); // Show first hint

		if (hints.length>1)
		{
			pointer.ctatdebug("We have more than one hint, enabling next button");
			next.setEnabled (true);
		}
		else
		{
			pointer.ctatdebug("We only have one hint, leaving next button disabled");
		}
	};

	/**
	 * Not sure if we need to override this
	 * @param aValue
	 */
	this.setEnabled=function setEnabled(aValue)
	{
		pointer.assignEnabled(aValue);

		if (pointer.getComponent()===null)
		{
			pointer.ctatdebug ("Error pointer.getComponent()==null");
			return;
		}

		pointer.getComponent ().disabled=!aValue;
	};

	/**
	 *
	 */
	this.goPrevious=function goPrevious ()
	{
		pointer.ctatdebug ("goPrevious ()");

		hintIndex--;

		next.setEnabled (true);

		if (hintIndex<=0)
		{
			hintIndex=0;

			previous.setEnabled (false);
		} else {
			previous.setEnabled (true);
		}

		hintContent.innerHTML = (CTATGlobals.languageManager.filterString (hints [hintIndex]));

		//var generator=new CTATGuid ();

		var builder = new CTATTutoringServiceMessageBuilder ();
		var tsMessage="";
		var transactionID = CTATGuid.guid ();
		hintSAI = new CTATSAI("previousButton", "ButtonPressed", "-1");
		tsMessage = builder.createInterfaceActionMessage(transactionID,hintSAI);
		//commLibrary.sendXML (tsMessage);

		var hintSAI = new CTATSAI("previousButton", "ButtonPressed", "hint request");
		commLoggingLibrary.logSemanticEvent(transactionID, hintSAI, "HINT_REQUEST", "");

		CTATCommShell.commShell.propagateShellEvent ("InterfaceAction",tsMessage);

		var indicator="HintWindow";
		var advice=pointer.getCurrentHint ();
		var associatedRulesXML=assocRulesBuilder.createAssociatedRulesMessageForHint([advice],
											     logHintSAI,
											     "student",
											     null,
											     "",
											     transactionID,
											     hints.length,
											     hintIndex+1);
		var associatedRulesMessage=new CTATMessage (messageParser.parse(associatedRulesXML));
		CTATCommShell.commShell.processAssociatedRules (associatedRulesMessage,indicator,advice);

		CTATCommShell.commShell.propagateShellEvent ("PreviousPressed",associatedRulesMessage);
	};

	/**
	 *
	 */
	this.goNext=function goNext ()
	{
		pointer.ctatdebug ("goNext ()");

		hintIndex++;

		previous.setEnabled (true);

		if (hintIndex>(hints.length-1))
		{
			hintIndex=(hints.length-1);
		}

		if (hintIndex>(hints.length-2))
		{
			next.setEnabled (false);
		} else {
			next.setEnabled (true);
		}

		hintContent.innerHTML = (CTATGlobals.languageManager.filterString (hints [hintIndex]));

		//var generator=new CTATGuid ();

		var builder = new CTATTutoringServiceMessageBuilder ();
		var tsMessage="";
		var transactionID = CTATGuid.guid ();
		hintSAI = new CTATSAI("nextButton", "ButtonPressed", "-1");
		tsMessage = builder.createInterfaceActionMessage(transactionID,hintSAI);

		var hintSAI = new CTATSAI("nextButton", "ButtonPressed", "hint request");
		commLoggingLibrary.logSemanticEvent(transactionID, hintSAI, "HINT_REQUEST", "");

		CTATCommShell.commShell.propagateShellEvent ("InterfaceAction",tsMessage);

		var indicator="HintWindow";
		var advice=pointer.getCurrentHint ();
		var associatedRulesXML=assocRulesBuilder.createAssociatedRulesMessageForHint([advice],
											     logHintSAI,
											     "student",
											     null,
											     "",
											     transactionID,
											     hints.length,
											     hintIndex+1);
		var associatedRulesMessage=new CTATMessage (messageParser.parse(associatedRulesXML));
		CTATCommShell.commShell.processAssociatedRules (associatedRulesMessage,indicator,advice);

		CTATCommShell.commShell.propagateShellEvent ("NextPressed",associatedRulesMessage);
	};
};

CTATHintWindow.prototype = Object.create(CTAT.Component.Base.Graphical.prototype);
CTATHintWindow.prototype.constructor = CTATHintWindow;

CTAT.ComponentRegistry.addComponentType('CTATHintWindow',CTATHintWindow);
