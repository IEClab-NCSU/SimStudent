/**-----------------------------------------------------------------------------
 $Author$
 $Date$
 $HeadURL$
 $Revision$

 -
 License:
 -
 ChangeLog:
 -
 Notes:

 */
goog.provide('CTATGlobalFunctions');

goog.require('CTATConfig');
goog.require('CTATGlobals');
goog.require('CTATSandboxDriver');
//goog.require('CTATConfiguration');

/**  */
CTATGlobalFunctions = {};
//window['CTATGlobalFunctions'] = CTATGlobalFunctions;

/**
*
*/
function unhighlightall(dummy)
{
	//console.log ("unhighlightall ()");

	if (!CTATShellTools.component_descriptions)
	{
		//console.log ("No component descriptions available, bump");
		return;
	}

	var comps = CTATShellTools.getAllComponents ();

	//console.log ("Calling unhighlight on " + comps.length + " components ...");

	for (var i=0;i<comps.length;i++)
	{
		var ref = comps[i];

		//console.log ("Calling ...");

		if (ref ["setHintHighlight"])
		{
			ref.setHintHighlight(false,null);
		}
	}
}

/**
 * Function for converting various truthy representations used in CTAT to
 * a boolean.
 * @param {String} str: a string
 * @returns {Boolean} true|false
 */
CTATGlobalFunctions.stringToBoolean = function stringToBoolean (str)
{
	switch(String(str).toLowerCase())
	{
		case "true": case "yes": case "1": return true;
		case "false": case "no": case "0": case "": case null: return false;
		default: return Boolean(str);
	}
};

/**
 * Generate or provide the most basic set of configuration parameters or obtain those
 * from the environment if available
 * @param value
 * @returns {Boolean}
 * @deprecated
 */
/*CTATGlobalFunctions.generateDefaultConfiguration = function()
{
	// We're in tutorshop and our basic list of flashvars should come from
	// the data-params iframe attribute
	var dataParams = CTATGlobalFunctions.decodeTutorShopParams(FlashVars);

	if(dataParams)
	{
		ctatdebug ("generateDefaultConfiguration() dataParams[authenticity_token] "+dataParams["authenticity_token"]);
		return dataParams;
	}
};
window['CTATGlobalFunctions']['generateDefaultConfiguration'] = CTATGlobalFunctions.generateDefaultConfiguration;*/
/**
* Tell whether we're delivering this tutor to an instructor (to review a student's work, e.g.)
* or to a student (the default). This implementation follows OLI use.
* @return {boolean} true if delivering to an instructor
*/
CTATGlobalFunctions.isInstructorMode = function()
{
	var vars = (flashVars ? flashVars.getRawFlashVars () : null);
	if (vars && vars ['deliverymode'])
	{
		return (vars ['deliverymode']=='delivery' ? false : true);
	}
	else
	{
		return false;
	}
};

/**
*
*/
CTATGlobalFunctions.getLoggingLibrary = function(getLoggingLibrary)
{
	if (commLoggingLibrary==null)
	{
		commLoggingLibrary=new CTATLoggingLibrary (true);
	}

	return (commLoggingLibrary);
};

/**
* Deprecated method, please use the member function in CTATConfiguration
* @deprecated
*/
CTATGlobalFunctions.setPreviewMode = function(aConfigurationObject,aValue)
{
	if (!CTATGlobalFunctions.isCTATObject (aConfigurationObject))
	{
		aConfigurationObject ['previewMode'] = aValue;
		return;
	}

	aConfigurationObject.setPreviewMode (aValue);
};

/**
* Deprecated method, please use the member function in CTATConfiguration
* @deprecated
*/
CTATGlobalFunctions.setCenterTutor = function(aConfigurationObject,aValue)
{
	if (!CTATGlobalFunctions.isCTATObject (aConfigurationObject))
	{
		aConfigurationObject ['centerTutor'] = aValue;
		return;
	}

	aConfigurationObject.setCenterTutor (aValue);
};

/**
* Deprecated method, please use the member function in CTATConfiguration
* @deprecated
*/
CTATGlobalFunctions.setTutorWidth = function(aConfigurationObject,w)
{
	if (!CTATGlobalFunctions.isCTATObject (aConfigurationObject))
	{
		aConfigurationObject ['width'] = w;
		return;
	}

	aConfigurationObject.setTutorWidth (w);
};

/**
* Deprecated method, please use the member function in CTATConfiguration
* @deprecated
*/
CTATGlobalFunctions.setTutorHeight = function(aConfigurationObject,h)
{
	if (!CTATGlobalFunctions.isCTATObject (aConfigurationObject))
	{
		aConfigurationObject ['height'] = h;
		return;
	}

	aConfigurationObject.setTutorHeight (h);
};

/**
* Deprecated method, please use the member function in CTATConfiguration
* @deprecated
*/
CTATGlobalFunctions.setTutorDimensions = function(aConfigurationObject,w,h)
{
	if (!CTATGlobalFunctions.isCTATObject (aConfigurationObject))
	{
		aConfigurationObject ['width'] = w;
		aConfigurationObject ['height'] = h;
		return;
	}

	aConfigurationObject.setTutorDimensions (w,h);
};

/**
* Deprecated method, please use the member function in CTATConfiguration
* @deprecated
*/
CTATGlobalFunctions.setTutorValue = function (aConfigurationObject,aKey,aValue)
{
	if (!CTATGlobalFunctions.isCTATObject (aConfigurationObject))
	{
		aConfigurationObject [aKey] = aValue;
		return;
	}

	aConfigurationObject.setTutorValue (aKey,aValue);
};

/**
* Deprecated method, please use the member function in CTATConfiguration
* @deprecated
*/
CTATGlobalFunctions.setCommunicationMode = function(aConfigurationObject,aMode)
{
	if (!CTATGlobalFunctions.isCTATObject (aConfigurationObject))
	{
		aConfigurationObject ['tutoring_service_communication'] = aMode;
		return;
	}

	aConfigurationObject.setCommunicationMode (aMode);
};

/**
* Deprecated method, please use the member function in CTATConfiguration
* @deprecated
*/
CTATGlobalFunctions.setRemoteSocketURL = function(aConfigurationObject,aURL)
{
	if (!CTATGlobalFunctions.isCTATObject (aConfigurationObject))
	{
		aConfigurationObject ['remoteSocketURL'] = aURL;
		return;
	}

	aConfigurationObject.setRemoteSocketURL (aURL);
};

/**
* Deprecated method, please use the member function in CTATConfiguration
* @deprecated
*/
CTATGlobalFunctions.setRemoteSocketPort = function(aConfigurationObject,aPort)
{
	if (!CTATGlobalFunctions.isCTATObject (aConfigurationObject))
	{
		aConfigurationObject ['remoteSocketPort'] = aPort;
		return;
	}

	aConfigurationObject.setRemoteSocketPort (aPort);
};

/**
*
*/
CTATGlobalFunctions.setProblemSummary= function (aSummary)
{
	// Process the damn thing here
};

/**
*
*/
CTATGlobalFunctions.isCTATObject=function (aVariable)
{
	if (typeof (testConfig)=="object")
	{
		if (testConfig ["getClassName"])
		{
			//console.log ("Config object is of type: " + testConfig.getClassName ());

			return (true);
		}
		else
		{
			//console.log ("Config object is not a CTAT object");
		}
	}

	return (false);
};

/**
*
*/
CTATGlobalFunctions.getCTATClassname = function (aVariable)
{
	if (typeof (testConfig)=="object")
	{
		if (testConfig ["getClassName"])
		{
			//console.log ("Config object is of type: " + testConfig.getClassName ());

			return (testConfig.getClassName ());
		}
		else
		{
			//console.log ("Config object is not a CTAT object");
		}
	}

	return ("object");
};

/**
 * Convert given value to a boolean.
 * @param value
 * @returns {Boolean}
 */
CTATGlobalFunctions.toBoolean = function(value) {
	if (typeof value === 'boolean')
		return value;
	else if (typeof value === 'string')
		return CTATGlobalFunctions.stringToBoolean(value);
	else if (typeof value === 'number')
		return (value>0);
	else if (value)
		return true;
	else
		return false;
};

/**
 *
 */
function noenter(e)
{
	//ctatdebug ("noenter ()");

	if (CTATConfig.platform_is_Google())
	{
		return (0);
	}

	e = e || window.event;
	var key = e.keyCode || e.charCode;

	return (key !== 13);
}

/**
 *
 * @param str
 * @returns {Boolean}
 */
/*function isEmpty(str)
{
	return (!str || 0 === str.length);
}*/ // unused

/**
 *
 */
CTATGlobalFunctions.isBlank = function isBlank(str)
{
	return (!str || /^\s*$/.test(str));
};
/**
 *
 * @param c
 * @returns
 */
function componentToHex(c)
{
	var hex = c.toString(16);
	return hex.length == 1 ? "0" + hex : hex;
}

/**
 *
 * @param r
 * @param g
 * @param b
 * @returns {String}
 */
function rgbToHex(r, g, b)
{
	return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
}

/**
 *
 * @param hex
 * @returns
 */
function hexToRgb(hex)
{
	var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);

	return result ?
			{
		r: parseInt(result[1], 16),
		g: parseInt(result[2], 16),
		b: parseInt(result[3], 16)
			} : null;
}

/**
 *
 * @param filename
 * @param filetype
 * Please use the version in ctatloader.js
 */
 /*
function loadjscssfile(filename, filetype)
{
	var fileref = null;
	if (filetype=="js")
	{
		//if filename is a external JavaScript file
		fileref=document.createElement('script');
		fileref.setAttribute("type","text/javascript");
		fileref.setAttribute("src", filename);
	}
	else if (filetype=="css")
	{
		//if filename is an external CSS file
		fileref=document.createElement("link");
		fileref.setAttribute("rel", "stylesheet");
		fileref.setAttribute("type", "text/css");
		fileref.setAttribute("href", filename);
	}

	if (fileref!==null)
	{
		getSafeElementsByTagName("head")[0].appendChild(fileref);
	}
}
*/

/**
 *
 */
function parseQueryStringArgs (aQuerySet)
{
	ctatdebug ("parseQueryStringArgs ()");

	var str = aQuerySet;

	ctatdebug ("Query String: " + str);

	var query = str.charAt(0) == '?' ? str.substring(1) : str;
	var args = {};

	if (query)
	{
		var fields = query.split('&');

		for (var f = 0; f < fields.length; f++)
		{
			var field = fields[f].split('=');
			args[decodeURIComponent(field[0])] = decodeURIComponent(field[1].replace(/\+/g, ' '));
		}
	}

	return args;
}

/**
 *
 * @param anOrientation
 */
function setOrientation(anOrientation)
{
	ctatdebug ("setOrientation ("+anOrientation+")");

	switch (anOrientation)
	{
	case -90:
	case 90:
		//orientation='landscape';
		if (mobileAPI)
		{
			mobileAPI.processOrientationChange ('landscape');
		}

		break;
	case 180: /* falls through */
	default:
		//orientation='portrait';
		if (mobileAPI)
		{
			mobileAPI.processOrientationChange ('portrait');
		}

		break;
	}
}

/**
 * In order to provide support to older browsers, here is an implementation of the Object.create
 * method. Source: @link https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/create
 */
if (!Object.hasOwnProperty('create')) {
	Object.create = (function() {
		function F(){}

		return function(o)
		{
			if (arguments.length != 1)
			{
				throw new Error('Object.create implementation only accepts one parameter.');
			}

			F.prototype = o;
			return new F();
		};
	})();
}

/**
 *
 */
function thisMovie(movieName)
{
	if (navigator.appName.indexOf("Microsoft") != -1)
	{
		return window[movieName];
	}
	else
	{
		return document[movieName];
	}
}

/**
 * Introspects an object.
 * http://www.syger.it/Tutorials/JavaScriptIntrospector.html
 *
 * @param name the object name.
 * @param obj the object to introspect.
 * @param indent the indentation (optional, defaults to "").
 * @param levels the introspection nesting level (defaults to 1).
 * @returns a plain text analysis of the object.
 */
function introspect (name, obj, indent, levels)
{
	//console.log ("introspect ("+name+")");

	indent = indent || "";

	if (this.typeOf(levels) !== "number") levels = 1;
	var objType = this.typeOf(obj);
	var result = [indent, name, " ", objType, " :"].join('');

	if (objType === "object")
	{
		if (levels > 0)
		{
			indent = [indent, "  "].join('');

			for (var prop in obj)
			{
				var property = this.introspect(prop, obj[prop], indent, levels - 1);
				result = [result, "\n", property].join('');
			}

			return result;
		}
		else
		{
			return [result, " ..."].join('');
		}
	}
	else if (objType === "null")
	{
		return [result, " null"].join('');
	}

	return [result, " ", obj].join('');
}

/**
 *
 */
function findPointOfAttachment (anInstance)
{
	ctatdebug ("findPointOfAttachment ("+anInstance+")");

	for (var t=0;t<movieclips.length;t++)
	{
		var aMovieClip=movieclips [t];

		ctatdebug ("Examining: " + aMovieClip.getName () + "...");

		if (aMovieClip.isRegistered (anInstance)===true)
		{
			return (aMovieClip);
		}
	}

	return (null);
}

/**
 * Important!! This function returns an object of type CTATMovieClip. This only
 * works if Flash MovieClips have been properly extracted previously in the
 * rendering process. So that means that findMovieClip should be called ideally
 * in the tutor's postprocess method, otherwise this function might fail
 */
function findMovieClip (anInstance)
{
	var formatted=anInstance.trim (); // Just in case

	ctatdebug ("findMovieClip ("+formatted.trim ()+")");

	for (var t=0;t<movieclips.length;t++)
	{
		var aMovieClip=movieclips [t];

		ctatdebug ("Examining: " + aMovieClip.getName () + "...");

		if (aMovieClip.getName ()==formatted)
		{
			return (aMovieClip);
		}
	}

	return (null);
}


/**
 *
 */
function colName(n,toUpperCase)
{
	ctatdebug ("colName ("+n+")");

	var s = "";

	while(n >= 0)
	{
		s = String.fromCharCode(n % 26 + 97) + s;
		n = Math.floor(n / 26) - 1;
	}

	if (toUpperCase===true)
	{
		s.toUpperCase ();
	}

	return s;
}


function selectText(target)
{
	//document.getElementById(target).focus();
	//document.getElementById(target).select();
}

function urldecode(str)
{
	return decodeURIComponent((''+str).replace(/\+/g, '%20'));
}

function detectIE() {
	var ua = window.navigator.userAgent;
	var msie = ua.indexOf('MSIE ');
	var trident = ua.indexOf('Trident/');

	if (msie > 0) {
		// IE 10 or older => return version number
		return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);
	}

	if (trident > 0) {
		// IE 11 (or newer) => return version number
		var rv = ua.indexOf('rv:');
		return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);
	}

	// other browser
	return false;
}

function listProperties (anObject)
{
	ctatdebug ("listProperties (l: " + anObject.length + ")");

	for(var propertyName in anObject)
	{
		ctatdebug ("["+propertyName+"]");
	}
}

function listPropertiesKV (anObject,asArray)
{
	ctatdebug ("listPropertiesKV (size: " + anObject.length + ")");

	if (asArray==true)
	{
		for(var i=0;i<anObject.length;i++)
		{
			ctatdebug ("["+i+"]: " + anObject[i]);
		}
	}
	else
	{
		for(var propertyName in anObject)
		{
			ctatdebug ("["+propertyName+"]: " + anObject[propertyName]);
		}
	}
}

function listAllDivAttributes (aDivObject)
{
	ctatdebug ("listAllDivAttributes ()");

	for (var i = 0, atts = aDivObject.attributes, n = atts.length, arr = []; i < n; i++)
	{
		pointer.ctatdebug ("Attribute: " + atts [i].nodeName +", with value: " + atts [i].nodeValue);
	}
}

/**
* Get the dimensions of a div's background image
*/
var getBackgroundDimensions = function (item)
{
	ctatdebug ("Using url: " + $(item).css('background-image'));

    var img = new Image();
    img.src = $(item).css('background-image').replace(/url\(|\)$|"/ig, '');
    return img.width + ' ' + img.height;
};

/**
* Get the dimensions of a div's background image
*/
var getBackgroundWidth = function (item)
{
	ctatdebug ("Using url: " + $(item).css('background-image'));

    var img = new Image();
    img.src = $(item).css('background-image').replace(/url\(|\)$|"/ig, '');
    return img.width;
};

/**
* Get the dimensions of a div's background image
*/
var getBackgroundHeight = function (item)
{
	ctatdebug ("Using url: " + $(item).css('background-image'));

    var img = new Image();
    img.src = $(item).css('background-image').replace(/url\(|\)$|"/ig, '');
    return img.height;
};

/**
*
*/
function getIndicesOf(searchStr, str, caseSensitive)
{
    var startIndex = 0, searchStrLen = searchStr.length;
    var index, indices = [];
    if (!caseSensitive) {
        str = str.toLowerCase();
        searchStr = searchStr.toLowerCase();
    }
    while ((index = str.indexOf(searchStr, startIndex)) > -1) {
        indices.push(index);
        startIndex = index + searchStrLen;
    }

    return indices;
}

/**
 * Takes a string and tries to convert it to a hex string.
 * @param {String} aColor	a string representation of a color
 * @returns {String} a string representation of the color in the format of #FFFFFF
 * or simply returns the string if it does not parse.
 */
CTATGlobalFunctions.formatColor = function(aColor) {
	if (/^#[0-9a-f]{6}$/i.test(aColor)) // if already a desired color format
		return aColor;
	var rgb = aColor.match(/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i);
	if (rgb!==null) {
		return rgbToHex(Number(rgb[1]),Number(rgb[2]),Number(rgb[3]));
	}
	var hex = aColor.match(/^#?([0-9a-f]{0,6})$/i); // short hex or missing #
	if (hex!==null) {
		var c= hex[1];
		while(c.length < 6)
			c = '0' + c;
		return '#'+c;
	}
	return aColor; // assume a color name or other valid color specification
};

/**
 * Initializes functions that generate sequential symbols/indicies.
 * (gensym is short for GenerateSymbol, an old lispism).
 * @protected
 * @returns {Object} containing z_index and div_id
 */
CTATGlobalFunctions.Gensym = function() {
	this.make_gensym = function() {
		var prefix = '';
		var index = 0;
		return {
			/**
			 * Set the prefix used in generating the symbol.
			 * @param p	coersed into a string
			 */
			set_prefix: function(p) {
				prefix = String(p);
			},
			/**
			 * Set the current index
			 * @param {Number} i	The current index to use.  Used to set the initial index.
			 */
			set_index: function(i) {
				index = i;
			},
			/**
			 * Generate a new symbol.
			 * @returns {String} prefix+index
			 */
			gensym: function() {
				var result = prefix + index;
				index += 1;
				return result;
			}
		};
	};

	/*** Define a new gensym'ed variable here ***/
	// z_index: <no_prefix><number>
	var z_index = this.make_gensym();
	z_index.set_index(2);
	// div_id: ctatdiv<number>
	var id_index = this.make_gensym();
	id_index.set_index(1);
	id_index.set_prefix('ctatdiv');
	/*** Add new gensym'ed variable to the following returned object ***/
	return {
		z_index: z_index.gensym,
		div_id: id_index.gensym
	};
};
/**
 * Generates symbols and indicies for the defined types:
 * z_index
 * div_id
 * @example
 * // returns 2 // on the first call
 * CTATGlobalFunctions.gensym.z_index();
 * @example
 * // returns 3
 * CTATGlobalFunctions.gensym.z_index();
 * @example
 * // returns 'ctatdiv1'
 * CTATGlobalFunctions.gensym.div_id();
 * @example
 * // returns 'ctatdiv2'
 * CTATGlobalFunctions.gensym.div_id();
 */
CTATGlobalFunctions.gensym = CTATGlobalFunctions.Gensym();

