/**-----------------------------------------------------------------------------
 $Author$
 $Date$
 $Header$
 $Name$
 $Locker$
 $Log$

 -
 License:
 -
 ChangeLog:
 -
 Notes:

 http://mottie.github.io/tablesorter/docs/example-widget-resizable.html

 Quick edit to change the code so that SVN will pick up this revision
 */
goog.provide('CTATTutor');

goog.require('CTATAudioButton');
goog.require('CTATButton');
goog.require('CTATCheckBox');
goog.require('CTATComboBox');
goog.require('CTATCommLibrary');
goog.require('CTATCommShell');
goog.require('CTATConfig');
goog.require('CTATConfiguration');
goog.require('CTATDoneButton');
goog.require('CTATDragNDrop');
goog.require('CTATFractionBar');
goog.require('CTATGlobalFunctions');
goog.require('CTATGlobals');
goog.require('CTATGroupingComponent');
goog.require('CTATHintButton');
goog.require('CTATHintWindow');
goog.require('CTATHTMLManager');
goog.require('CTATIFrameManager');
goog.require('CTATImageButton');
goog.require('CTATJSON');
goog.require('CTATJumble');
goog.require('CTATMobileTutorHandler');
goog.require('CTATMovieClip');
goog.require('CTATNumberLine');
goog.require('CTATNumericStepper');
goog.require('CTATPieChart');
// goog.require('CTATPlayButton'); not part of the official release
goog.require('CTATRadioButton');
goog.require('CTATSAI');
goog.require('CTATSandboxDriver');
goog.require('CTATScrim');
goog.require('CTATScrollPaneComponent');
goog.require('CTATSkillSet');
goog.require('CTATSkillWindow');
goog.require('CTATSubmitButton');
goog.require('CTATTable');
goog.require('CTATTextArea');
goog.require('CTATTextField');
goog.require('CTATTextInput');
//goog.require('CTATTools');
//goog.require('CTAT.ToolTutor');
goog.require('CTATVideo');
goog.require('CTATXML');
//goog.require('OLIMessageHandler');
goog.require('CTATPackage');
goog.require('CTATSequencer');
goog.require('CTATAssistments'); // Included because otherwise the compiler won't stick the Assistments code in our library
goog.require('CTATEnabledInPreview');

CTATTutor.drawing=false;
CTATTutor.onMobile=false;

CTATTutor.tutorInitialized=false;

CTATTutor.flashVars = null;

/**
 * Create CTATTutor.parser that will only initialize the parser the first time
 * it is needed and will create it based on CTATConfig.parserType.  This will
 * effectively delay creation to the last possible moment.
 */
Object.defineProperty(CTATTutor,'parser', {
	get: function() {
		if (!this._parser) {
			if (CTATConfig.parserType_is_XML())
			{
				//pointer.ctatdebug ("Creating XML parser ...");
				ctatdebug('Creating XML parser ...');
				this._parser=new CTATXML ();
			}
			else if (CTATConfig.parserType_is_JSON())
			{
				//pointer.ctatdebug ("Creating JSON parser ...");
				this._parser=new CTATJSON ();
			}
		}
		return this._parser;
	}
});

CTATTutor.initializeHTMLComponents = function()
{
	for (var CTATComponentType in CTAT.ComponentRegistry)
	{
		//console.trace(CTATComponentType);
		var CTATComponent = CTAT.ComponentRegistry[CTATComponentType]; /* CONSTRUCTORS */

		// This walks the registered components, probably want to change to walking the dom.
		$('.'+CTATComponentType).each(function()
		{
			// for each component of the given class
			if (!$(this).data('CTATComponent')) 
			{ // assume initialized if already has CTATComponent (needed for CTATTable)
				var ctat_component = new CTATComponent();
	
				//ctatdebug('Attaching CTAT tutoring to '+$(this).attr('id'));

				if ($(this).attr('id'))
				{
					ctat_component.setName($(this).attr('id'));
				}
				else
				{
					this.setAttribute('id', CTATGlobalFunctions.gensym.div_id());
					ctat_component.setName(this.getAttribute('id'));
				}
	
				ctat_component.setDivWrapper(this);
				ctat_component.processAttributes();
				ctat_component.init();
				ctat_component.processTabOrder ();
				ctat_component.setEnabled(ctat_component.getEnabled()); // need post init setting so that it can be propagated correctly.

				if (ctat_component.isFeedbackComponent ()==false)
				{
					var compEntry=new CTATComponentDescription ();
					compEntry.type=ctat_component.getClassName ();
					compEntry.name=ctat_component.getName ();
					compEntry.setComponentPointer (ctat_component);

					CTATShellTools.registerComponentDescription(compEntry);
				}

				//ctat_component.initialize ();
				$(this).data('CTATComponent',ctat_component);
				if (CTATConfiguration.get('previewMode'))
				{
					var restore = ctat_component.getDivWrap().getAttribute('data-ctat-enabled');
					var isEnabled = ctatEnabledInPreview[ctat_component.getClassName()];
					if (!isEnabled) isEnabled = false;
					ctat_component.setEnabled(isEnabled);
					ctat_component.getDivWrap().setAttribute('data-ctat-enabled', restore);
				}
			}
		});
	}

	CTATShellTools.listComponents ();

	ctatdebug("initializeHTMLComponents () done");
};

/**
*	Called when a component's attributes are updated by Silex in order
*	to apply the changes.  Finds the component object based on the div,
*	then passes that object to the function parameter along with the 
*	argument provided.
*	@param componentDiv the div element wrapping the CTAT component.
*	@param func the function to which the component object should be passed
*	@param arg the argument to pass to the function along with the component
*		object
**/
CTATTutor.callComponentFunction = function(componentDiv, func, arg)
{
	var componentArr = CTATShellTools.findComponent(componentDiv.id);
	if (componentArr && componentArr.length > 0)
	{
		var componentObj = componentArr[0];
		var val = null;
		if (func) 
			val = func(componentObj, arg);
		return val;
	}
}

/**
 *
 */
function assignNameTranslator (aTranslator)
{
	nameTranslator=aTranslator;
}

/**
 *
 */
CTATTutor.drawTutor = function drawTutor ()
{
	//ctatdebug ("drawTutor ()");

	if (this.drawing===true)
	{
		return;
	}

	this.drawing=true;

	for (var i in CTATShellTools.component_descriptions)
	{
		var aDesc=CTATShellTools.component_descriptions [i];

		//ctatdebug ("Drawing component: " + i);

		var component=aDesc.getComponentPointer ();

		if (component!==null)
		{
			//ctatdebug ("Drawing component: " + aDesc.name);

			component.drawComponent ();
		}
	}
	this.drawing=false;
};

/**
 *
 */
CTATTutor.initialize = function initialize()
{
	var useragent = navigator.userAgent.toLowerCase();

	//alert ("User-agent header sent: " + navigator.userAgent);

	if (useragent.search("iphone")>0)
	{
		//alert ('ipone');
		CTATTutor.onMobile=true;
	}
	else if (useragent.search("ipod")>0)
	{
		//alert ('ipod');
		CTATTutor.onMobile=true;
	}
	else if (useragent.search("android")>0)
	{
		//alert ('android');
		CTATTutor.onMobile=true;
	}

	//alert ("CTATTutor.onMobile: " + CTATTutor.onMobile);

	var isMobile=getSafeElementById("pageor");
	if (isMobile!==null)
	{
		if (CTATTutor.onMobile===false)
		{
			//alert ('hiding page orientation ...');

			isMobile.style.display='none';
		}
	}

	ctatdebug ("initialize ()");

	this.initializeHTMLComponents();

	var raw=flashVars.getRawFlashVars ();
	var startConnectedTutor=true;

	if (CTATConfiguration.get('previewMode')) 
	{
		ctatdebug("In preview mode...");
		startConnectedTutor=false;
	}	
	
	if (startConnectedTutor==true)
	{
		CTATCommShell.commShell=new CTATCommShell ();
		CTATCommShell.commShell.init (CTATTutor);
	}
	else CTATScrim.scrim.scrimDown();
};

/**
 * Called by CTATCommShell
 */
CTATTutor.createInterface=function createInterface ()
{
	ctatdebug ("createInterface ("+Object.keys(CTATShellTools.component_descriptions).length+")");

	if (CTATGlobals.ignoreInterfaceDescriptions==true)
	{
		ctatdebug ("No need to process interface description messages, the interface should already be ready.");

		this.postProcess ();

		this.drawTutor ();

		//await ProblemRestoreEnd message before removing scrim

		return;
	}

	// First rebuild the basic interface from the serialized interface

	if (CTATGlobals.interfaceElement)
	{
		ctatdebug ("Re-creating interface ...");

		//var intProps=interfaceElement.childNodes;
		var intProps=CTATTutor.parser.getElementChildren (CTATGlobals.interfaceElement);

		//useDebugging=true;

		CTATTutor.createStaticInterface (null,intProps,null);

		//useDebugging=false;
	}

	// Next create all the CTAT components ...

	for (var i in CTATShellTools.component_descriptions)
	{
		var aDesc=CTATShellTools.component_descriptions [i];
		//ctatdebug(aDesc);
		if (!aDesc)
		{
			alert ("Internal error parsing component at index " + i);
			return;
		}

		if (!aDesc.name)
		{
			alert ("Internal error parsing component at index " + i + " (no name attribute available)");
			return;
		}

		if (aDesc.name.indexOf ("null.")==-1)
		{
			ctatdebug ("Component: " + aDesc.name + ", type: " + aDesc.type);

			if (aDesc.type=="CTATCommShell")
			{
				if (CTATCommShell.commShell)
				{
					CTATCommShell.commShell.setName (aDesc.name);
				}

				if (aDesc.type=="CTATCommShell")
				{
					ctatdebug ("Tutor dimensions: " + aDesc.width + "x" + aDesc.height);

					//>---------------------------------------------------------------

					//var tutorCanvas=checkTutorCanvas ();
					var tutorCanvas=getSafeElementById(ctatcontainer);

					if (tutorCanvas!==null)
					{
						ctatdebug ("Setting canvas dimensions from: " + tutorCanvas.width+"px, "+ tutorCanvas.height+"px, to: " + aDesc.width+"px, "+ aDesc.height+"px");

						tutorCanvas.width=aDesc.width;
						tutorCanvas.height=aDesc.height;

						tutorCanvas.style.width=aDesc.width;
						tutorCanvas.style.height=aDesc.height;

						ctatdebug ("Canvas dimensions now: " + tutorCanvas.width+"px, "+ tutorCanvas.height+"px");

						//centerTutor(aDesc.width, aDesc.height);
						//CTATScrim.scrim.resizeScrim(aDesc.width, aDesc.height);
					}
					else
						ctatdebug ("Error: tutor canvas is null, can't adjust size");

					//>---------------------------------------------------------------

					var tutorContainer=getSafeElementById(ctatcontainer);

					if (tutorContainer!==null)
					{
						tutorContainer.style.width=(aDesc.width+"px");
						tutorContainer.style.height=(aDesc.height+"px");
					}
					else
						ctatdebug ("Error: tutor container is null, can't adjust size");

					//>---------------------------------------------------------------
				}
			} else if(CTAT.ComponentRegistry.hasOwnProperty(aDesc.type)) {
				ctatdebug('Creating ('+aDesc.type+') :'+aDesc.name);
				var regComp = new CTAT.ComponentRegistry[aDesc.type] (aDesc,
						aDesc.x, aDesc.y, aDesc.width, aDesc.height);
				regComp.setName(aDesc.name);
				if ((aDesc.type=="CTATTextInput") || (aDesc.type=="CTATTextArea")) {
					// apparently text components need an explicit enable
					regComp.setEnabled (true);
				}
				// excluded from tab order by setting regComp.isTabIndexable = false
				// The default value is set in the component definitions.
				regComp.setTabIndex(aDesc.tabIndex);
				aDesc.setComponentPointer(regComp);
				regComp.initialize();
				/*if ((aDesc.type=="CTATRadioButton") || (aDesc.type=="CTATCheckBox")) {
					// reset label placement.
					regComp.setLabelPlacement(regComp.getLabelPlacement());
				}*/
				ctatdebug(regComp.getDivWrap());
			} else {
				ctatdebug('ERROR: Unrecognized component type '+aDesc.type+' for '+aDesc.name);
			}
		}
	}

	this.postProcess ();

	this.drawTutor ();

	//useDebugging=true;

	ctatdebug ("Tutor has been intialized from BRD, recalculating canvas position and size ...");

	//checkTutorCanvas ();

	//useDebugging=false;

	//await ProblemRestoreEnd message before removing scrim
};
/**
 *
 */
CTATTutor.postProcess=function postProcess ()
{
	ctatdebug ("postProcess ()");

	//>----------------------------------------------------------------------------------

	for (var i in CTATShellTools.component_descriptions)
	{
		var ref=CTATShellTools.component_descriptions [i];

		//ctatdebug ("Obtaining component for " + ref.name + " with type: " + ref.type);

		var component=ref.getComponentPointer ();

		if (component!==null)
		{
			//>---------------------------------------------------------------------------------

			if (component.getClassName ()=="CTATTable")
			{
				//component.adjustTableContents ();
			}

			//>---------------------------------------------------------------------------------

			if (component.postProcess
					//(component.getClassName ()=="CTATScrollPaneComponent") ||
					//(component.getClassName ()=="CTATComponentContainerReference") ||
					//(component.getClassName ()=="CTATGroupingComponent")
			)
			{
				//useDebugging=true;
				component.postProcess ();
				//useDebugging=false;
			}
			//>---------------------------------------------------------------------------------
		}
		else
		{
			ctatdebug ("Error: component pointer "+i+" is null");
		}
	}

	//>----------------------------------------------------------------------------------
};
/**
 *
 */
CTATTutor.createStaticInterface=function createStaticInterface (aParent,intProps,aMovieClip)
{
	ctatdebug ("createStaticInterface ()");

	var parent=getSafeElementById(ctatcontainer);

	if (aParent!==null)
	{
		parent=aParent;
	}

	for (var t=0;t<intProps.length;t++)
	{
		var intNode=intProps [t];

		//ctatdebug (intNode.nodeName);
		ctatdebug (this.parser.getElementName (intNode));

		if (this.parser.getElementName (intNode)=="timeline")
		{
			ctatdebug ("Timeline node found, obtaining visual elements ...");

			var interf=this.parser.getElementChildren (intNode);

			this.createStaticInterface (null,interf,null);

			return; // we know there's nothing more in there here
		}


		if (this.parser.getElementName (intNode)=="ctatcomponent")
		{
			//var inst=intNode.attributes.getNamedItem("instance").value;
			var inst=this.parser.getElementAttr ("instance");

			if (aMovieClip)
			{
				ctatdebug ("Registering existence of CTAT component on MovieClip container: " + inst);

				aMovieClip.addComponent (inst);
			}
			//else
			//	ctatdebug ("Internal error: no MovieClip object available to attach CTAT component reference to");
		}

		//>--------------------------------------------------------------------

		var x,y;
		var width,height;
		var instName,descString;
		//if (intNode.nodeName=="shape")
		if (this.parser.getElementName (intNode)=="shape")
		{
			//useDebugging=true;

			/*
			var x=intNode.attributes.getNamedItem("x").value;
			var y=intNode.attributes.getNamedItem("y").value;
			var width=intNode.attributes.getNamedItem("width").value;
			var height=intNode.attributes.getNamedItem("height").value;
			var instName=intNode.attributes.getNamedItem("instance").value;
			 */

			x=this.parser.getElementAttr (intNode,"x");
			y=this.parser.getElementAttr (intNode,"y");
			width=this.parser.getElementAttr (intNode,"width");
			height=this.parser.getElementAttr (intNode,"height");
			instName=this.parser.getElementAttr (intNode,"instance");

			ctatdebug ("Creating shape: " + instName + " at: " + x +","+ y+","+width+","+height);

			descString=("data:image/png;base64, "+this.parser.getNodeTextValue (intNode));

			var imgA=new Image();

			imgA.setAttribute("style", "position: absolute; top: " + y + "px; left:" + x + "px; z-index:"+CTATGlobalFunctions.gensym.z_index()+";");
			imgA.setAttribute('id',instName);
			imgA.setAttribute('src',descString);

			parent.appendChild(imgA);

			//currentZIndex++;

			//useDebugging=false;
		}

		//>--------------------------------------------------------------------

		//if (intNode.nodeName=="statictext")
		if (this.parser.getElementName (intNode)=="statictext")
		{
			/*
			x=intNode.attributes.getNamedItem("x").value;
			y=intNode.attributes.getNamedItem("y").value;
			width=intNode.attributes.getNamedItem("width").value;
			height=intNode.attributes.getNamedItem("height").value;
			instName=intNode.attributes.getNamedItem("instance").value;
			 */

			x=this.parser.getElementAttr (intNode,"x");
			y=this.parser.getElementAttr (intNode,"y");
			width=this.parser.getElementAttr (intNode,"width");
			height=this.parser.getElementAttr (intNode,"height");
			instName=this.parser.getElementAttr (intNode,"instance");

			ctatdebug ("Creating static text: " + instName + " at: " + x +","+ y+","+width+","+height);

			descString=("data:image/png;base64, "+this.parser.getNodeTextValue (intNode));

			var imgB=new Image();

			imgB.setAttribute("style", "position: absolute; top: " + y + "px; left:" + x + "px; z-index:"+CTATGlobalFunctions.gensym.z_index()+";");
			imgB.setAttribute('id',instName);
			imgB.setAttribute('src',descString);

			parent.appendChild(imgB);

			//currentZIndex++;
		}

		//>--------------------------------------------------------------------

		//if (intNode.nodeName=="movieclip")
		if (this.parser.getElementName (intNode)=="statictext")
		{
			//instName=intNode.attributes.getNamedItem("instance").value;
			instName=this.parser.getElementAttr ("instance");

			ctatdebug ("Creating movieclip: " + instName);

			/*
			var aX=intNode.attributes.getNamedItem("x").value;
			var aY=intNode.attributes.getNamedItem("y").value;
			var aWidth=intNode.attributes.getNamedItem("width").value;
			var aHeight=intNode.attributes.getNamedItem("height").value;
			 */

			var aX=this.parser.getElementAttr (intNode,"x");
			var aY=this.parser.getElementAttr (intNode,"y");
			var aWidth=this.parser.getElementAttr (intNode,"width");
			var aHeight=this.parser.getElementAttr (intNode,"height");

			var aClip=new CTATMovieClip (instName,aX,aY,aWidth,aHeight);

			var newParent=aClip.wrapComponent (parent);

			ctatdebug ("Created movieclip: " + instName + " at: " + aClip.x +","+ aClip.y+","+aClip.width+","+aClip.height);

			movieclips.push (aClip);

			//var subProps=intNode.childNodes;
			var subProps=this.parser.getElementChildren (intNode);

			this.createStaticInterface (newParent,subProps,aClip);
		}

		//>--------------------------------------------------------------------
	}
};

/**
 *
 */
CTATTutor.runTutor = function()
{
	ctatdebug ("runTutor ()");

	if (CTATGlobals.tutorRunning===true)
	{
		ctatdebug ("The tutor is already running");
		return;
	}

	if (CTATSkillSet.skills==null)
	{
		CTATSkillSet.skills=new CTATSkillSet ();
	}

	window.onerror = function(errorMsg, url, lineNumber)
	{
		var formatter=new CTATHTMLManager ();

		ctatdebug(formatter.htmlEncode (errorMsg) + " in " + url + ", line " + lineNumber);
		ctatdebug(formatter.htmlEncode (errorMsg) + " in " + url + ", line " + lineNumber);
	};

	centerTutorContainer ();

	//ctatcanvas = checkTutorCanvas ();

	CTATTutor.initialize();

	CTATGlobals.tutorRunning=true;

	ctatdebug ("runTutor () ... all set");
};

/**
 * @param {Array<string>} aFlashVars indices are individual flashvar names
 * @param {string} id of the tutor canvas, defaults to 'container' (Optional)
 * @param {string} id of an html5 canvas, managed by the tutor and scaled to tutor area for backdrop drawing (Optional)
 * @param {boolean} usingFlash (Optional)
 */
CTATTutor.initTutor = function(aFlashVars,aDiv,aCanvas,usingFlash) // Main entry point
{
	//console.trace("initTutor() #aFlashVars "+(aFlashVars ? aFlashVars.length : null)+", usingFlash "+usingFlash);
	ctatdebug ("initTutor() #aFlashVars "+(aFlashVars ? aFlashVars.length : null)+", usingFlash "+usingFlash);

	if (CTATTutor.tutorInitialized==true)
	{
		ctatdebug("Tutor already initialized, probably in author mode");
		if (aFlashVars.previewMode)
		{
			CTATScrim.scrim.scrimDown();
			ctatdebug("In preview mode...");
		}	
		return;
	}

	CTATConfiguration.generateDefaultConfigurationObject(aFlashVars);

	switch(CTATConfiguration.get("show_debug_traces"))
	{
	case "true":
	case "basic":
		useDebuggingBasic = true;  // if traces from useDebugging too processor-heavy
		break;
	case "on":
	case "full":
		useDebugging = true;
		break;
	case "false":
	case "off":
		useDebugging = false;
		useDebuggingBasic = false;
		break;
	default:
		useDebuggingBasic = true;  // if parameter present, probably want some tracing
	}

	//CTATTutor.flashVars = aFlashVars;
	
	if(usingFlash == null)
	{
		usingFlash = CTATConfiguration.usingFlash();
	}

	if(usingFlash)  // Flash has its own scrim, so remove the JavaScript one
	{
		CTATScrim.scrim.scrimDown();
	}

	CTATCommLibrary.setAuthenticityToken(CTATConfiguration.get('authenticity_token'));

	if (aDiv)
	{
		ctatcontainer=aDiv;
	}

	var el = document.getElementById(ctatcontainer);

	if(el)
	{
		el.classList.add("CTATTutorContainer");
	}

	var debugtraces=getSafeElementById("debugtraces");

	if (debugtraces!==null)
	{
		if (debugtraces.checked===true)
			useDebugging=true;
		else
			useDebugging=false;
	}

	//useDebugging = true;

	//var tempFlashVars=CTATConfiguration.getRawFlashVars(); // unused

	/*
	 * Create here a global sendToTutor() for the Flash CommShell,
	 * which is ignorant of the CTAT.ToolTutor namespace.
	 */
	ctatdebug("initTutor() CTATConfiguration.get('mode')="+CTATConfiguration.get("mode")+
			", window.sendToTutor="+window.sendToTutor);
	if(CTATConfiguration.get("swf_name") && !window["sendToTutor"])
	{
		window.sendToTutor = function(message) {
			ctatdebug("window.sendToTutor(" + message + ") CTAT.ToolTutor.tutor " + CTAT.ToolTutor.tutor);
			if (CTAT.ToolTutor.tutor) {
				return CTAT.ToolTutor.tutor.receiveFromInterface(message);
			} else {
				return CTAT.ToolTutor.tutorMessages.push(message);
			}
		};
		window.registerInterface = function(msgHandler) {
			//ctatdebug("window.registerInterface(" + msgHandler + ") CTAT.ToolTutor.tutor " + CTAT.ToolTutor.tutor);
			CTAT.ToolTutor.registerInterfaceMessageHandler(msgHandler);
		};
	}

	//ctatdebug("initTutor() tempFlashVars[swf_name] "+tempFlashVars["swf_name"]+", window.sendToTutor "+window.sendToTutor);
	//ctatdebug("initTutor() tempFlashVars[question_file] "+tempFlashVars["question_file"]);

	// after tutorPrep, the canonical flashvar name should be tutoring_service_communication
	if(String(CTATConfiguration.get("tutoring_service_communication")).toLowerCase() == "javascript")
	{
		if(typeof(CTATExampleTracer) == "undefined" || !CTATExampleTracer)  // don't goog.require('CTATExampleTracer') in case not in UI-only bundles
		{
			var tracerMissingMsg = "Tutoring service communication parameter is \"JavaScript\" but class\nCTATExampleTracer is missing. Use a different ctat-*.js script.";
			CTATScrim.scrim.warningScrimUp(tracerMissingMsg);  // should overlay Flash scrim
		}
		else
		{
			CTAT.ToolTutor.registerTutor(new CTATExampleTracer());
		}
	}

	// mobileAPI=new CTATMobileTutorHandler ("keyboardUI",tempFlashVars ['keyboard']); should be nowhere for awhile

	ctatdebug ("initTutor ()");

	if (CTATConfiguration.get("tutoring_service_communication")=="applet")
	{
		deployJava.runApplet({id: 'TSApplet', width: 150, height: 10}, {jnlp_href: '/ctat_applet/TSApplet.jnlp'}, '1.6');
	}

	if(!usingFlash)
	{
		CTATTutor.runTutor ();
	}
	
	
	CTATTutor.tutorInitialized=true;
}


if (!window.hasOwnProperty('initTutor')) {
	window['initTutor'] = CTATTutor.initTutor;
}


/**
 * This is a function accessible by TutorShop
 */
function receiveFromTutor ()
{
	ctatdebug ("receiveFromTutor ()");
}

/**
 * This is a function accessible by TutorShop and is used to do a rapid
 * shutdown of a tutor whilst at the same time saving its state.
 */
function saveAndQuit ()
{
	ctatdebug ("saveAndQuit ()");
}

/**
 * Use this function ONLY if you're using the CTAT test pages.
 */
function prepTutorArea ()
{
	//ctatdebug ("prepTutorArea ()");

	initTutor ();
}

window['prepTutorArea'] = prepTutorArea;

/**
 *
 */
function assignAnonymousGradingProcessor (aFunction)
{
	CTATCommShell.commShell.assignAnonymousGradingProcessor (aFunction);
}
/**
 *
 */
function gradeAnonymousComponent (aSelection,anAction,anInput)
{
	ctatdebug ("gradeAnonymousComponent ()");

	var tsMessage=new CTATSAI(aSelection,anAction,anInput);
	CTATCommShell.commShell.processComponentAction(tsMessage);
}

/**
 *
 */
function testTutor(aVars)
{
	ctatdebug ("testTutor ()");

	window.onerror = function(errorMsg, url, lineNumber)
	{
		var formatter=new CTATHTMLManager ();

		//useDebugging=true; // This should always go through
		ctatdebug(formatter.htmlEncode (errorMsg) + " in " + url + ", line " + lineNumber);
		//useDebugging=false;
	};

	//var internalFlashVars=tutorPrep (aVars);

	if (CTATSkillSet.skills==null)
	{
		CTATSkillSet.skills=new CTATSkillSet ();
	}

	var connector=new CTATCommLibrary ();
	//connector.send_post ("http://qa.pact.cs.cmu.edu/courses",'<?xml version=\"1.0\" encoding=\"UTF-8\"?><hello></hello>');
	connector.send ("http://augustus.pslc.cs.cmu.edu/crossdomain.xml");
}

/**
*
* Position absolute and then top:50% and left:50% places the top edge at vertically center of the screen,
* and left edge at horizontally center, then by adding margin-top to negative of height of the div i.e
* -100 shifts it above by 100, similarly for margin-left. This gets div exactly in the center of the page.
*
* <div id="outPopUp"></div>
*
* #outPopUp
* {
*      position:absolute;
*      width:300px;
*      height:200px;
*      z-index:15;
*      top:50%;
*      left:50%;
*      margin:-100px 0 0 -150px;
*      background:red;
* }
*
* Notes: remember that this function only works if the width and height of the tutor have been
* specified. We might want to modify the code to assume a default size if this isn't the case or
* not try to center at all.
*/
function centerTutorContainer ()
{
	ctatdebug("centerTutorContainer ()");

	var tutorContainer=getSafeElementById(ctatcontainer);

	if (tutorContainer==null)
	{
		ctatdebug ("Tutor container not found, bump");
		return;
	}

	var raw=null;

	if (flashVars)
	{
		raw=flashVars.getRawFlashVars ();
	}
	else
	{
		ctatdebug ("No flashvars yet, bump");
		return;
	}

    var actualWidth='550';
	var actualHeight='450';

	actualWidth=tutorContainer.offsetWidth;
	actualHeight=tutorContainer.offsetHeight;

	if (raw)
	{
		if (raw ['width'] && raw ['height'])
		{
			ctatdebug ("We have raw width and height variables in our flashvars: " + raw ['width'] +"," +raw ['height']);

			actualWidth=raw ['width'];
			actualHeight=raw ['height'];
		}
	}

	if (raw ['centerTutor'])
	{
		if (raw ['centerTutor']==true)
		{
			var wOffset=Number(actualWidth/2);
			var hOffset=Number(actualHeight/2);
			var marginOffset=('-'+wOffset+'px 0 0 -'+hOffset+'px;');

			ctatdebug ("Moving tutor over by: " + marginOffset);

			tutorContainer.style.position='absolute';
			tutorContainer.style.top='0';
			tutorContainer.style.left='0';
			tutorContainer.style.right='0';
			tutorContainer.style.bottom='0';
			tutorContainer.style.margin='auto';
		}
	}
	else
	{
		ctatdebug ("The tutor is not configured to center the container, bump");
	}
}

/**
*
*/
function checkTutorCanvas ()
{
	ctatdebug ("checkTutorCanvas ()");

	var tutorContainer=getSafeElementById(ctatcontainer);
	var testCanvas = getSafeElementById("main-canvas");
	var raw=flashVars.getRawFlashVars ();

    var actualWidth='550';
	var actualHeight='450';

	if (tutorContainer)
	{
		ctatdebug ("Recording the actual CSS width and height: " + tutorContainer.offsetWidth + " , " + tutorContainer.offsetHeight);

		actualWidth=tutorContainer.offsetWidth;
		actualHeight=tutorContainer.offsetHeight;
	}

	if (raw)
	{
		if (raw ['width'] && raw ['height'])
		{
			ctatdebug ("We have tutor size flashvars, using those instead: " + raw ['width'] + " , " + raw ['height']);

			actualWidth=raw ['width'];
			actualHeight=raw ['height'];
		}
	}

	if (testCanvas===null)
	{
		ctatdebug ("No canvas available, creating ...");

		testCanvas = document.createElement("canvas");
		testCanvas.id = "main-canvas";
		testCanvas.innerHTML="Your browser does not support CTAT. Please update or use another browser.";

		ctatdebug ("Setting canvas to: 0,0," + actualWidth + " , " + actualHeight);

		var mainContainer=getSafeElementById (ctatcontainer);
		mainContainer.appendChild(testCanvas);

		testCanvas.style.width=(actualWidth+'px');
		testCanvas.style.height=(actualHeight+'px');
	}
	else
	{
		ctatdebug ("Setting canvas to: 0 , 0, " + actualWidth + " , " + actualHeight);

		testCanvas.style.top='0';
		testCanvas.style.left='0';
		testCanvas.style.width=(actualWidth+'px');
		testCanvas.style.height=(actualHeight+'px');
	}

	return (testCanvas);
}
