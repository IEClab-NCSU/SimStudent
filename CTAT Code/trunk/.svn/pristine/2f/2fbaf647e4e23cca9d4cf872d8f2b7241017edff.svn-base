/**
*
*/
function ctatdebug (aMessage)
{
	Logger.log(aMessage); 
}

/**
 * Retrieves all the rows in the active spreadsheet that contain data 
 * and logs the values for each row.
 * For more information on using the Spreadsheet API, see
 * https://developers.google.com/apps-script/service_spreadsheet
 */
function readRows() 
{
	var sheet = SpreadsheetApp.getActiveSheet();
	var rows = sheet.getDataRange();
	var numRows = rows.getNumRows();
	var values = rows.getValues();

	for (var i = 0; i <= numRows - 1; i++) 
	{
		var row = values[i];
		Logger.log(row);
	}
};

/**
*
*/
function rangeValuesToString (aValueSet)
{
   return (""); 
}

/**
*
*/
function createOnEditQueue() 
{  
    ctatdebug ("resetOnEditQueue()");
  
    /*
    var cache=PropertiesService.getDocumentProperties();
    cache.setProperty ("stringQueue","");  
    */
  
    var cache = CacheService.getScriptCache();
    cache.put ("stringQueue",""); 
}

/**
*
*/
function resetOnEditQueue() 
{  
    ctatdebug ("resetOnEditQueue()");
  
    /*
    var cache=PropertiesService.getDocumentProperties();
    cache.setProperty ("stringQueue","");  
    */
  
    var cache = CacheService.getScriptCache();
    cache.put ("stringQueue","");   
}

/**
*
*/
function dumpPrivateCache() 
{ 
    ctatdebug ("dumpPrivateCache()");
  	
    /*
    var cache=PropertiesService.getDocumentProperties();
    var currentQueue=cache.getProperty("stringQueue");
    */
  
    var cache = CacheService.getScriptCache();
    var currentQueue=cache.get ("stringQueue");  
  
    ctatdebug (currentQueue);
}

/**
* https://developers.google.com/apps-script/reference/cache/cache-service
*/
function enqueueOnEdit(range,values) 
{    
    var entry= (range + ";"+ values);
  
    ctatdebug ("enqueueOnEdit ("+entry.toString ()+")");
  
    dumpPrivateCache();
    
    var cache = CacheService.getScriptCache();    
    var currentQueue=cache.get ("stringQueue"); 
  
    if (currentQueue!="")
    {
      currentQueue+="&";
    }
  
    currentQueue+=entry;
  
    //cache.setProperty ("stringQueue",currentQueue); 
    cache.put ("stringQueue",currentQueue);
    
    dumpPrivateCache();
}

/**
* https://developers.google.com/apps-script/reference/cache/cache-service
*/
function dequeueOnEdit() 
{
    ctatdebug ("dequeueOnEdit ()"); 
    
    var cache = CacheService.getScriptCache();    
    var currentQueue=cache.get ("stringQueue"); 
      
    ctatdebug ("Returning composed string (before): " + currentQueue);
  
    cache.put ("stringQueue",""); 
  
    ctatdebug ("Returning composed string (after): " + currentQueue);
  
	return (currentQueue);
}

/**
* Gets the dimensions of an array. The return value is a 1 dimensional
* array where each entry is the length of the array at that index. Found
* at: http://stackoverflow.com/questions/10237615/get-size-of-dimensions-in-array
* For example: 
*
*      size ([[1, 1, 1], [1, 1, 1]])
*
* would return: 
*
*      [2, 3]
*/
function size(ar)
{
    var row_count = ar.length;
    var row_sizes = []
    
    for(var i=0;i<row_count;i++)
    {
        row_sizes.push(ar[i].length)
    }
  
    return [row_count, Math.min.apply(null, row_sizes)]
}

/**
*
*/
function onEdit(e) 
{
  onCellEdit (e);
}

/**
*
*/
function onCellEdit(e) 
{  
	ctatdebug ("onCellEdit ()");
  
    // Whatever we do, we need to have a copy of the app so that we can providing chaining
  	var tutorUiApp = UiApp.getActiveApplication();
  
    // First remove the existing highlight indicator
    //removePreviousHighlight (); 
  
	var stringToDisplay = e.range.getA1Notation();
  
    // Then remove the grading color because the user might
    // have pasted cells that were pre-graded
  
	var targetCell=getTargetCell (stringToDisplay);
    
	if (targetCell!=null)
	{
		targetCell.setFontColor('#000000');  
	} 
    else
    {
      ctatdebug ("Error: target cell(s) "+a1Notation+" not found");
      return tutorUiApp;
    }  
    
    var values        = "";
    var rangeFormulas = e.range.getFormulas ();
    var rangeValues   = e.range.getValues ();
    var rangeResults  = new Array ();    
    var sizeChecker   = size (e.range.getValues ());
    
    //ctatdebug ("Original range formulas: " + JSON.stringify (rangeFormulas)); 
    //ctatdebug ("Original range values: " + JSON.stringify (rangeValues)); 
    //ctatdebug ("Range dimensions: " + JSON.stringify (sizeChecker));
  
    var i=0;
    var j=0;
  
    // Allocate new array based on the size information we obtained earlier
    
    for (i=0;i<sizeChecker [0];i++)
    {
      var newArray=new Array (sizeChecker [1]); 
      rangeResults.push (newArray);
    }
  
    // Fill the new array with either formulas or values depending on what
    // our iteration finds ...
  
    //ctatdebug ("i dimension: " + sizeChecker [0]);
  
    for (i=0;i<sizeChecker [0];i++)
    {      
        //ctatdebug ("j dimension: " + sizeChecker [1]);
      
        for (j=0;j<sizeChecker [1];j++)
        {
           if ((rangeFormulas [i][j]!=undefined) && (rangeFormulas [i][j]!=""))
           {
             //ctatdebug ("Picking formula at: " + i + "," + j + " : " + rangeFormulas[i][j]);
             rangeResults [i][j]=rangeFormulas[i][j];
           }
           else
           {
             //ctatdebug ("Picking value at: " + i + "," + j + " : " + rangeValues[i][j]);
             rangeResults [i][j]=rangeValues[i][j];
           }
        }
    }
  
    // Stringify the resulting 2 dimensional array into a JSON string and
    // add it to our queue
    
    values=JSON.stringify (rangeResults);
  
    //ctatdebug ("Resulting JSON array: " + values);
  
	enqueueOnEdit (stringToDisplay,values);

	return tutorUiApp;
};

/**
*
*/
function onChange(e) 
{
  //onCellChange (e);
}

/**
*
*/
function onCellChange(e) 
{
    ctatdebug ("onCellChange ()");

    var tutorUiApp = UiApp.getActiveApplication();
  
  /*
  	var a1Notation = e.range.getA1Notation();
  

  
    // First remove the highlight indicator
  
    removePreviousHighlight (); 
  
    // Then remove the grading color because the user might
    // have pasted cells that were pre-graded
  
	var targetCell=getTargetCell (a1Notation);
    
	if (targetCell!=null)
	{
		targetCell.setFontColor('#000000');  
	} 
    else
    {
      ctatdebug ("Error: target cell(s) "+a1Notation+" not found");
    }  
*/    
  
	return tutorUiApp;
};

/**
* Google Sheet Access
* https://developers.google.com/apps-script/reference/spreadsheet/sheet
* https://developers.google.com/apps-script/reference/spreadsheet/range
*/
function getTargetCell (a1Notation) 
{
    ctatdebug ("getTargetCell ("+a1Notation+")");
  
	var tutorUiApp = UiApp.getActiveApplication();
    
	var sheet = SpreadsheetApp.getActiveSpreadsheet();
  
	var range = sheet.getRange(a1Notation);
  
	return (range);
}  

/**
* Google Sheet Access
* https://developers.google.com/apps-script/reference/spreadsheet/sheet
* https://developers.google.com/apps-script/reference/spreadsheet/range
*/
function scrollTo (a1Notation) 
{
    ctatdebug ("scrollTo ("+a1Notation+")");
  
	var tutorUiApp = UiApp.getActiveApplication();
    
	var sheet = SpreadsheetApp.getActiveSpreadsheet();
  
	sheet.setActiveSelection(a1Notation);
}  


/**
* Google Sheet Access
* https://developers.google.com/apps-script/reference/spreadsheet/sheet
* https://developers.google.com/apps-script/reference/spreadsheet/range
*/
function setFontColor (a1Notation, color) 
{
	ctatdebug ("setFontColor ("+a1Notation+","+color+")");

	var targetCell=getTargetCell (a1Notation);
    
	if (targetCell!=null)
	{
		targetCell.setFontColor(color);  
	} 
    else
    {
      ctatdebug ("Error: target cell(s) "+a1Notation+" not found");
    }
};

/**
* Google Sheet Access
* https://developers.google.com/apps-script/reference/spreadsheet/sheet
* https://developers.google.com/apps-script/reference/spreadsheet/range
*/
function setFontColors (a1Notation, color) 
{
	ctatdebug ("setFontColors ("+a1Notation+","+color+")");

	var targetCell=getTargetCell (a1Notation);
    
	if (targetCell!=null)
	{
		targetCell.setFontColors(color);  
	} 
    else
    {
      ctatdebug ("Error: target cell(s) "+a1Notation+" not found");
    }
};

/**
*
*/
function removePreviousHighlight ()
{
    ctatdebug ("removePreviousHighlight ()");
  
    var targetCell=null;
  
    //>-------------------------------------------------
  
  	//var cache = CacheService.getScriptCache();
    var cache=PropertiesService.getDocumentProperties();
  
	//var previousHighlight = cache.get("highlighted");
    previousHighlight=cache.getProperty("highlighted");
  
    if (previousHighlight)
    {  
      if (previousHighlight!="")
      {
        ctatdebug ("Removing previous highlight on: " + previousHighlight);
        
	    targetCell=getTargetCell (previousHighlight);
    
	    if (targetCell!=null)
	    {
		   targetCell.setBackground("#ffffff");  
	    } 
        else
        {
          ctatdebug ("Error: target cell(s) "+a1Notation+" not found");
        }    
        
        //cache.put ("highlighted", "");
        cache.setProperty ("highlighted", "");        
      }  
      else
      {
        ctatdebug ("previousHighlight==empty");
      }
    }
    else
    {
      ctatdebug ("!previousHighlight");
    }
}

/**
* Google Sheet Access
* https://developers.google.com/apps-script/reference/spreadsheet/sheet
* https://developers.google.com/apps-script/reference/spreadsheet/range
*/
function setHintHighlight (a1Notation, color) 
{
	ctatdebug ("setHintHighlight ("+a1Notation+","+color+")");
  
    removePreviousHighlight ();

    //var cache = CacheService.getScriptCache();
    var cache=PropertiesService.getDocumentProperties();
  
    var targetCell=null;

    //>-------------------------------------------------

	targetCell=getTargetCell (a1Notation);
    
	if (targetCell!=null)
	{
		targetCell.setBackground(color);  
      
        //cache.put ("highlighted", a1Notation);
        cache.setProperty ("highlighted", a1Notation);
	} 
    else
    {
      ctatdebug ("Error: target cell(s) "+a1Notation+" not found");
    }  
  
    //>-------------------------------------------------
  
    scrollTo (a1Notation);
    
    //>-------------------------------------------------
};

/**
* Google Sheet Access
* https://developers.google.com/apps-script/reference/spreadsheet/sheet
* https://developers.google.com/apps-script/reference/spreadsheet/range
*/
function showCorrect (a1Notation, color) 
{
	ctatdebug ("showCorrect ("+a1Notation+","+color+")");

    removePreviousHighlight ();
  
	var targetCell=getTargetCell (a1Notation);
    
	if (targetCell!=null)
	{
		targetCell.setFontColor(color);  
	} 
    else
    {
      ctatdebug ("Error: target cell(s) "+a1Notation+" not found");
    }
};

/**
* Google Sheet Access
* https://developers.google.com/apps-script/reference/spreadsheet/sheet
* https://developers.google.com/apps-script/reference/spreadsheet/range
*/
function showIncorrect (a1Notation, color) 
{
	ctatdebug ("showIncorrect ("+a1Notation+","+color+")");

    removePreviousHighlight ();
  
	var targetCell=getTargetCell (a1Notation);
    
	if (targetCell!=null)
	{
		targetCell.setFontColor(color);  
	} 
    else
    {
      ctatdebug ("Error: target cell(s) "+a1Notation+" not found");
    }
};

/**
* Google Sheet Access
* https://developers.google.com/apps-script/reference/spreadsheet/sheet
* https://developers.google.com/apps-script/reference/spreadsheet/range
*/
function setText (a1Notation, aValue) 
{
	ctatdebug ("setText ("+a1Notation+" , "+aValue+") typeof -> ("+typeof a1Notation+")");
  
    if (a1Notation.indexOf (":")!=-1)
    {
      setTexts (a1Notation,aValue);
    }
    else
    {  
      var targetCell=getTargetCell (a1Notation);
      var stringTest=a1Notation +"?";
    
	  if (targetCell!=null)
      {
        ctatdebug ("Setting single cell ("+stringTest+") ...");
        
		targetCell.setValue(aValue);  
      }
	} 
  
    resetOnEditQueue();
  
    return (true);
};

/**
* Google Sheet Access
* https://developers.google.com/apps-script/reference/spreadsheet/sheet
* https://developers.google.com/apps-script/reference/spreadsheet/range
*/
function setTexts (a1Notation, aValue) 
{
	ctatdebug ("setTexts ("+a1Notation+" , "+aValue+") typeof -> ("+typeof a1Notation+")");
  
	var targetCell=getTargetCell (a1Notation);
    var stringTest=a1Notation +"?";
    
	if (targetCell!=null)
	{
       ctatdebug ("Setting range ("+stringTest+") ...");
        
       targetCell.setValues(JSON.parse(aValue));          
	} 
  
    resetOnEditQueue();
  
    return (true);
};

/**
* Google Sheet Access
* https://developers.google.com/apps-script/reference/spreadsheet/sheet
* https://developers.google.com/apps-script/reference/spreadsheet/range
*/
function setFormula (a1Notation, aValue) 
{
	ctatdebug ("setFormula ("+a1Notation+","+aValue+")");
  
    if (a1Notation.indexOf (":")!=-1)
    {
      setFormulas (a1Notation,aValue);
    }
    else
    {
	  var targetCell=getTargetCell (a1Notation);
    
	  if (targetCell!=null)
	  {
	  	targetCell.setFormula(aValue);  
	  }
    } 
  
    resetOnEditQueue();
};

/**
* Google Sheet Access
* https://developers.google.com/apps-script/reference/spreadsheet/sheet
* https://developers.google.com/apps-script/reference/spreadsheet/range
*/
function setFormulas (a1Notation, aValue) 
{
	ctatdebug ("setFormulas ("+a1Notation+","+aValue+")");
  
    ctatdebug (" - - " + aValue + " - - ");
  
    var JSONObject=null;
  
    try
    {
      JSONObject=JSON.parse(aValue);
    }
    catch (e)
    {
      ctatdebug ("Error parsing JSON: " + e);
      return;
    }
  
    ctatdebug ("JSON Parsed, applying to cells ...");
  
	var targetCell=getTargetCell (a1Notation);
    
	if (targetCell!=null)
	{
		targetCell.setFormulas(JSONObject);  
	}
  
    resetOnEditQueue();
};

/**
* Google Sheet Access
* https://developers.google.com/apps-script/reference/spreadsheet/sheet
* https://developers.google.com/apps-script/reference/spreadsheet/range
*/
function setBackground (a1Notation, aColor) 
{
	ctatdebug ("setBackground ("+a1Notation+","+aColor+")");
  
	var targetCell=getTargetCell (a1Notation);
    
	if (targetCell!=null)
	{
		targetCell.setBackground(aColor);
	}
    else
    {
      ctatdebug ("Error: target cell(s) "+a1Notation+" not found");
    }  
};

/**
*
*/
function onInstall(e) 
{
  onOpen(e);
  // Perform additional setup as needed.
}


/**
 * http://stackoverflow.com/questions/19004774/popup-authorization-code-documentapp-google-apps-script
 */
function onOpen() 
{    
  var ui = SpreadsheetApp.getUi();
  
	/**
	* Create a CTAT menu anyway, just in case that's the only way we can authorize
	*/
	/*
	ui.createMenu('CTAT')
		.addItem("Start Tutor", 'startTutor')
		.addItem("Authorize Tutor", functionName)
		.addToUi();  
	*/   
  
	/**
	* UserProperties API is deprecated
	* File: Code Line: 406
	* The API has been marked as deprecated which means that the feature should be avoided and may be 
	* removed in the future. Consider using an alternative solution.
	*/
  
	var props=PropertiesService.getDocumentProperties();
  
	if(!props.getProperty('author'))
	{
		ui.createMenu('CTAT')
		.addItem("Authorize this app", 'authorize')
		.addToUi();
            
		var html = HtmlService.createHtmlOutputFromFile('authwelcome').setTitle("Install Menu").setWidth(400);
		ui.showSidebar(html);
	}
	else
	{
		ui.createMenu('CTAT').addItem("Show Sidebar", 'restore').addToUi();
    
		startTutor ();
	}  
};

/**
* http://stackoverflow.com/questions/19004774/popup-authorization-code-documentapp-google-apps-script
*/
function authorize()
{
	var props=PropertiesService.getDocumentProperties();
	props.setProperty('author','yes');
	var ui = SpreadsheetApp.getUi();
	var html = HtmlService.createHtmlOutput('Authorization complete<br><br>please refresh this page and the tutor should start automatically.').setTitle("Confirmation").setWidth(400);
	ui.showSidebar(html);
}

/**
* http://stackoverflow.com/questions/19004774/popup-authorization-code-documentapp-google-apps-script
*/
function restore ()
{
    ctatdebug ("restore()");
    
	var htmlOutput = HtmlService.createHtmlOutputFromFile("TutorSidebar.html").setTitle("CTAT Tutor Sidebar");
 
	SpreadsheetApp.getUi().showSidebar(htmlOutput);
}

/**
* http://stackoverflow.com/questions/19004774/popup-authorization-code-documentapp-google-apps-script
*/
function startTutor ()
{
    ctatdebug ("startTutor()");
  
 	createOnEditQueue();
  
	var htmlOutput = HtmlService.createHtmlOutputFromFile("TutorSidebar.html").setTitle("CTAT Tutor Sidebar");
 
	SpreadsheetApp.getUi().showSidebar(htmlOutput);
      
    // resetSheet ();
  
    // jumpToProblem (); 
}

/**
*
*/
function resetSheet ()
{  
	ctatdebug ("resetSheet()");
    
  /*
	var targetCell=getTargetCell ("D32:J41");
    
	if (targetCell!=null)
	{
		targetCell.setValue("");  
        targetCell.setFontColor("#000000"); 
        targetCell.setBackground("#ffffff");
	}
  */  
}

/**
* Google Sheet Access
* https://developers.google.com/apps-script/reference/spreadsheet/sheet
* https://developers.google.com/apps-script/reference/spreadsheet/range
*/
function getSheetSelectedRange ()
{
	ctatdebug ("getSheetSelectedRange()");
  
	var sheet=SpreadsheetApp.getActiveSheet();
  
	var range=sheet.getActiveRange();
  
	ctatdebug ("Selected range: " + range.getA1Notation());
  
	return (range.getA1Notation());  
}

/**
*
*/
function getSheetName ()
{
   var sheet=SpreadsheetApp.getActiveSheet();
  
   return (sheet.getName().replace (" ","_").toLowerCase());
}

/**
* https://developers.google.com/apps-script/reference/spreadsheet/spreadsheet#setActiveSheet%28Sheet%29
*/
function jumpToProblem ()
{
	var ss = SpreadsheetApp.getActiveSpreadsheet();

	SpreadsheetApp.setActiveSheet(ss.getSheets()[3]);  
}
