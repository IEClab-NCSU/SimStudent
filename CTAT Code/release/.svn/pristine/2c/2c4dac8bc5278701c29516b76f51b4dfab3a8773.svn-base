<html>
<head>
<title>WebSocket Test</title>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

<style>

body {background-color:white;padding:50px 50px}

.table { display: table; border: 0px solid black; }
.title { display: table-caption;  border: 0px solid black;}
.heading { display: table-row;	font-weight: bold; text-align: center; border: 0px solid black; }
.row { display: table-row;  border: 0px solid black;}
.cell 
{ 
	display: table-cell; 
	font:normal normal 12px/14px "Courier New",Courier,Monospace;
	color:black;
	border: 0px solid black;
}

.cell.content
{ 
	display: table-cell; 
	font:normal normal 12px "Courier New",Courier,Monospace;
	color: white;
	background: #555;
	background-image: -webkit-linear-gradient(#555 50%, #505050 50%);
	background-image:    -moz-linear-gradient(#555 50%, #505050 50%);
	background-image:     -ms-linear-gradient(#555 50%, #505050 50%);
	background-image:      -o-linear-gradient(#555 50%, #505050 50%);
	background-image:         linear-gradient(#555 50%, #505050 50%);
	background-position: 0 0;
	background-repeat: repeat;
	background-size: 4.5em 4.5em;	
	
	-webkit-box-shadow: inset 0px 0px 10px 3px rgba(0,0,0,0.41);
	-moz-box-shadow: inset 0px 0px 10px 3px rgba(0,0,0,0.41);
	box-shadow: inset 0px 0px 10px 3px rgba(0,0,0,0.41);
}

.fconsole
{
	border: 3px rgb(157, 153, 153) solid;
	border-radius: 5px 5px 5px 5px;
	-moz-border-radius: 5px 5px 5px 5px;
	-webkit-border-radius: 5px 5px 5px 5px;
	
	padding: 5px;
	background: rgb(208, 205, 205);
	color: rgb(25,25,25);
	font-size: 12px;
	font-family: Courier, monospace;
	font-style: normal;
	text-decoration: inherit;
	text-align: left;
	line-height: 12px;
-webkit-box-shadow: 3px 3px 5px 0px rgba(0,0,0,0.75);
-moz-box-shadow: 3px 3px 5px 0px rgba(0,0,0,0.75);
box-shadow: 3px 3px 5px 0px rgba(0,0,0,0.75);
	overflow: auto;
	padding: 0px;
	margin: 0px;
	resize: both;	
}

</style>

<script language="javascript" type="text/javascript">

var lNumbers=1;

/**
*
*/
var TWWebsocket=function (aURL)
{
	var wsUri = aURL;
	var output;
	var websocket=null;
	var pointer=this;
	var outgoingQueue=[];
	var ready=false;
		
	var before=0;
	var after=0;
	
	/**
	*
	*/
	this.init=function init ()
	{
		pointer.twdebug('init ()');
	
		websocket = new WebSocket(wsUri);
		
		websocket.addEventListener('open', function(e)
		{
			pointer.twdebug('STATUS: open');
			
			ready=true;					
			
			pointer.twdebug('Connection open, flushing outgoing queue ...');
			
			var timeDriver = new Date();
			before = timeDriver.getTime(); 
			
			if (outgoingQueue.length>0)
			{
				for (var i=0;i<outgoingQueue.length;i++)
				{
					websocket.send (outgoingQueue [i]);
				}
				
				outgoingQueue=[];
			}
		});
		
		websocket.addEventListener('message', function(e)
		{
			var timeDriver = new Date();
			after = timeDriver.getTime(); 
		
			pointer.twdebug('STATUS: message');
			pointer.twdebug('Received: ' + e.data + ' <b>('+(after-before)+'ms)</b>');
		});
		
		websocket.addEventListener('close', function(e)
		{
			pointer.twdebug('STATUS: close');
			
			ready=false;
		});		
		
		websocket.addEventListener('error', function(e)
		{
			pointer.twdebug('STATUS: error');
			
			ready=false;			
		});	
	}
	
	this.send=function send (aMessage)
	{
		pointer.twdebug('send ('+aMessage+')');
	
		if (ready==false)
		{	
			pointer.twdebug('Connection not ready yet, storing ...');
			outgoingQueue.push (aMessage);
		}
		else		
		{
			pointer.twdebug('Connection ready, sending data ...');
			
			var timeDriver = new Date();
			before = timeDriver.getTime(); 
			websocket.send (aMessage);
		}
	};
	
	/**
	*
	*/	
	this.twdebug=function twdebug(message)
	{
		console.log (message);
						
		document.getElementById ('lines').innerHTML+=(lNumbers + '<br>');
		
		document.getElementById ('content').innerHTML+=(message + '<br>');

		document.getElementById ('fconsole').scrollTop = document.getElementById ('fconsole').scrollHeight;
		
		lNumbers++;		
	};
}

//>-------------------------------------------------------------------------------

var wsDriver=null;
var timerId=-1;

/**
*
*/
function startTest ()
{
	console.log ("Testing Websocket availability ...");
	
	wsDriver=new TWWebsocket (document.getElementById ("url").value);	
	
	if( typeof(WebSocket) != "function" ) 
	{
		wsDriver.twdebug("Error: Your browser does not support HTML5 Web Sockets. Try Google Chrome instead.");
	}
	else
	{
		wsDriver.twdebug ("Success, websockets are supported");
		
		wsDriver.twdebug ("Starting automated test ...");
		
		wsDriver.init ();
		
		timerId=window.setInterval(testConnection, 3000);				
	}
}

/**
*
*/
function stopTest ()
{
	wsDriver.twdebug ("Stopping test");
	
	clearTimeout (timerId);
}

var iteration=1;

/**
*
*/
function testConnection ()
{
	wsDriver.send ("--test-"+iteration+"--");
	iteration++;
}
  
</script>
</head>

<body>
<h2>WebSocket Test</h2>

<button onclick="startTest()">Start Test</button> 
<button onclick="stopTest()">Stop Test</button> 
Host: <input type="text" id="url" value="ws://echo.websocket.org/" size="50">
<br>
<br>
<div id="fconsole" class="fconsole" style="width: 600px; height: 700px; ">
	<div class="table" style="width: 100%; height: 100%">
		<div class="row">
			<div class="cell" style="border-right: 1px solid black; text-align: right; padding-right: 5px; width: 35px; background: rgb(255, 255, 204);">
				<pre id="lines"></pre>
			</div>
			<div class="cell content" style="padding-left: 5px;">
				<pre id="content"></pre>
			</div>			
		</div>
	</div>
</div>

</body>
</html>
